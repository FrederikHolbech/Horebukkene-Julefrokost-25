<!doctype html>
<html lang="da">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HOREBUKKENE - Julefrokost</title>
  <style>
    :root {
      --bg: #0b0d12;
      --card: rgba(255, 255, 255, .06);
      --text: rgba(255, 255, 255, .92);
      --muted: rgba(255, 255, 255, .65);
      --border: rgba(255, 255, 255, .12);
      --accent: #7c5cff;
      --ok: #24d18f;
      --bad: #ff5c7a;
      --shadow: 0 20px 60px rgba(0, 0, 0, .35);
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(800px 400px at 20% 0%, rgba(124, 92, 255, .25), transparent 60%),
        radial-gradient(800px 400px at 80% 10%, rgba(0, 255, 209, .12), transparent 60%),
        var(--bg);
      min-height: 100vh;
      padding: 24px;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 24px;
    }

    .main-content {
      min-width: 0;
    }

    .device-tracker {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .03));
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 20px;
      backdrop-filter: blur(12px);
      height: fit-content;
      position: sticky;
      top: 24px;
      max-height: calc(100vh - 48px);
      overflow-y: auto;
    }

    .device-tracker h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 16px 0;
      text-align: center;
      color: var(--accent);
    }

    .team-progress {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .team-progress-item {
      background: rgba(255, 255, 255, .04);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    .team-progress-item .team-progress-name {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 8px;
      font-size: 15px;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .task-list-item {
      font-size: 12px;
      color: var(--muted);
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-list-item.completed {
      color: var(--ok);
    }

    .task-count {
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }

    @media (max-width: 1024px) {
      .wrap {
        grid-template-columns: 1fr;
      }

      .device-tracker {
        position: static;
      }
    }

    .brand {
      font-size: 48px;
      line-height: 1.0;
      letter-spacing: -0.03em;
      margin: 0 0 24px 0;
      text-transform: uppercase;
      text-align: center;
    }

    /* Scoreboard Section */
    .scoreboard-section {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .03));
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 24px;
      backdrop-filter: blur(12px);
      margin-bottom: 24px;
    }

    .scoreboard-title {
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 16px 0;
      text-align: center;
    }

    .scoreboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .team {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .04);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all .2s;
    }

    .team:hover {
      background: rgba(255, 255, 255, .06);
      border-color: rgba(124, 92, 255, .3);
    }

    .team-name {
      font-size: 20px;
      font-weight: 600;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 8px;
      transition: background .2s;
    }

    .team-name:hover {
      background: rgba(255, 255, 255, .08);
    }

    .team-score {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .score-display {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      min-width: 60px;
      text-align: center;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      transition: background .2s;
    }

    .score-display:hover {
      background: rgba(124, 92, 255, .15);
    }

    .score-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, .2);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
    }

    .score-btn:hover {
      background: rgba(124, 92, 255, .3);
      border-color: var(--accent);
    }

    .score-btn:active {
      transform: scale(0.95);
    }

    .scoreboard-controls {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    /* Task Grid */
    .task-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .task-card {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .03));
      border-radius: 14px;
      padding: 24px;
      cursor: pointer;
      transition: all .2s;
      backdrop-filter: blur(12px);
    }

    .task-card:hover {
      background: linear-gradient(180deg, rgba(124, 92, 255, .15), rgba(124, 92, 255, .08));
      border-color: rgba(124, 92, 255, .4);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .task-card-number {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .task-card-title {
      font-size: 22px;
      font-weight: 600;
      margin: 0 0 12px 0;
    }

    .task-card-description {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
    }

    /* Task Detail View */
    .task-detail {
      display: none;
    }

    .task-detail.active {
      display: block;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, .12);
      color: var(--text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 15px;
      transition: all .2s;
      margin-bottom: 24px;
    }

    .back-btn:hover {
      background: rgba(124, 92, 255, .2);
      border-color: rgba(124, 92, 255, .4);
    }

    /* Task Section */
    .task-section {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .03));
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 32px;
      backdrop-filter: blur(12px);
    }

    .tasks-overview {
      display: block;
    }

    .tasks-overview.hidden {
      display: none;
    }

    .task-header {
      margin-bottom: 24px;
    }

    .task-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .pill {
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, .12);
      padding: 6px 12px;
      border-radius: 999px;
    }

    .task-title {
      font-size: 28px;
      font-weight: 600;
      margin: 0 0 12px 0;
    }

    .task-description {
      font-size: 16px;
      color: var(--muted);
      line-height: 1.5;
    }

    .task-content {
      margin: 24px 0;
    }

    .btn {
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, .12);
      color: var(--text);
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      transition: all .2s;
      font-weight: 500;
    }

    .btn:hover {
      background: rgba(124, 92, 255, .2);
      border-color: rgba(124, 92, 255, .4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.primary {
      background: rgba(124, 92, 255, .3);
      border-color: rgba(124, 92, 255, .5);
    }

    .task-nav {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 24px;
    }

    /* Modal for PIN */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(180deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: var(--shadow);
    }

    .modal h2 {
      margin: 0 0 16px 0;
      font-size: 24px;
    }

    .team-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 20px 0;
    }

    .team-selector-btn {
      background: rgba(255, 255, 255, .06);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      color: var(--text);
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
    }

    .team-selector-btn:hover {
      background: rgba(124, 92, 255, .15);
      border-color: var(--accent);
    }

    .team-selector-btn.selected {
      background: rgba(124, 92, 255, .25);
      border-color: var(--accent);
    }

    .current-team-badge {
      display: inline-block;
      background: rgba(124, 92, 255, .2);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .modal input {
      width: 100%;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      padding: 12px;
      border-radius: 12px;
      font-size: 18px;
      text-align: center;
      letter-spacing: 4px;
      margin-bottom: 16px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-buttons .btn {
      flex: 1;
    }

    .error-msg {
      color: var(--bad);
      font-size: 14px;
      margin-top: -8px;
      margin-bottom: 12px;
      text-align: center;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-10px);
      }

      75% {
        transform: translateX(10px);
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="main-content">
      <h1 class="brand">üéÑ HOREBUKKENE üéÑ</h1>

      <!-- Scoreboard -->
      <div class="scoreboard-section">
        <h2 class="scoreboard-title">Scoreboard</h2>
        <div class="scoreboard" id="scoreboard"></div>
        <div class="scoreboard-controls">
          <button class="btn" onclick="resetScores()">Nulstil Point</button>
          <button class="btn" onclick="resetTasks()">Nulstil Opgaver</button>
        </div>
      </div>

      <!-- Task Area -->
      <div class="task-section">
        <!-- Overview of all tasks -->
        <div id="tasksOverview" class="tasks-overview">
          <h2 style="font-size: 32px; font-weight: 600; margin: 0 0 24px 0;">Opgaver</h2>
          <div class="task-grid" id="taskGrid"></div>
        </div>

        <!-- Individual task detail view -->
        <div id="taskDetail" class="task-detail">
          <button class="back-btn" onclick="showTasksOverview()">‚Üê Tilbage til opgaver</button>

          <div class="task-header">
            <div class="task-meta">
              <span class="pill" id="taskCounter">Opgave 1/5</span>
              <span class="pill" id="taskStatus">Ikke startet</span>
            </div>
            <h2 class="task-title" id="taskTitle">Alfabetet Challenge</h2>
            <p class="task-description" id="taskDescription">Skriv alfabetet a-z s√• hurtigt som muligt. Du skal g√∏re det
              p√•
              under 10 sekunder!</p>
          </div>

          <div class="task-content" id="taskContent">
            <!-- Task content will be inserted here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Device Tracker Sidebar -->
    <div class="device-tracker">
      <h3>üèÜ Opgave Fremskridt</h3>
      <div class="team-progress" id="teamProgress">
        <div style="text-align: center; color: var(--muted); font-size: 13px; padding: 20px 0;">
          Ingen opgaver gennemf√∏rt endnu
        </div>
      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="modal" id="pinModal">
    <div class="modal-content">
      <h2 id="modalTitle">Indtast PIN</h2>
      <input type="password" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="error-msg" id="errorMsg"></div>
      <div class="modal-buttons">
        <button class="btn" onclick="closeModal()">Annuller</button>
        <button class="btn" id="pinOkBtn">OK</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h2 id="editModalTitle">Rediger</h2>
      <input type="text" id="editInput" placeholder="" />
      <div class="modal-buttons">
        <button class="btn" onclick="closeEditModal()">Annuller</button>
        <button class="btn" id="editOkBtn" onclick="saveEdit()">Gem</button>
      </div>
    </div>
  </div>

  <!-- Team Selector Modal -->
  <div class="modal" id="teamSelectorModal">
    <div class="modal-content">
      <h2>V√¶lg dit hold</h2>
      <p style="color: var(--muted); margin-bottom: 20px;">V√¶lg hvilket hold denne enhed repr√¶senterer</p>
      <div class="team-selector" id="teamSelector"></div>
      <div class="modal-buttons">
        <button class="btn primary" onclick="confirmTeamSelection()" style="width: 100%;">Bekr√¶ft</button>
      </div>
    </div>
  </div>

  <script>
    const PIN = "1202";
    let teams = [
      { name: "Hold 1", score: 0 },
      { name: "Hold 2", score: 0 },
      { name: "Hold 3", score: 0 },
      { name: "Hold 4", score: 0 }
    ];

    let currentAction = null;
    let currentTeamIndex = null;
    let editType = null;
    let selectedTeamIndex = null;

    // Task system
    let currentTaskIndex = 0;
    let completedTasks = [];
    let activeTimers = [];

    const tasks = [
      {
        title: "Find Sangen - 10 Point",
        description: "G√¶t sangen ud fra emoji! üéµ",
        type: "emoji-songs"
      },
      {
        title: "Klik Udfordring - 10 Point",
        description: "Tryk p√• knappen 75+ gange p√• 10 sekunder! üñ±Ô∏è",
        type: "click-challenge"
      },
      {
        title: "Beer Pong Challenge - 15 Point",
        description: "Kast bolden i kopperne 4 gange i streg! üç∫",
        type: "beer-pong"
      },
      {
        title: "Fysiologi Quiz - 10 Point",
        description: "Svar p√• 5 sp√∏rgsm√•l om fysiologi! üß†",
        type: "physiology-quiz"
      },
      {
        title: "Buca eller Vand - 5 Point",
        description: "Drik vand eller sambuca - kan Dunkin g√¶tte det? ü•É",
        type: "trick-host"
      },
      {
        title: "Suger√∏rs Challenge - 5 Point",
        description: "Drik en √∏l gennem et suger√∏r! üç∫ü•§",
        type: "straw-challenge"
      },
      {
        title: "√òlbong Challenge - 10 Point",
        description: "Tag en √∏lbong p√• under 2,5 sekund! üç∫‚ö°",
        type: "beerbong-challenge"
      },
      {
        title: "Strava L√∏b - 10 Point",
        description: "L√∏b en kilometer og vis Dunkin bevis fra Strava! üèÉ‚Äç‚ôÇÔ∏è",
        type: "strava-run"
      },
      {
        title: "Matematik - 10 Point",
        description: "L√∏s 10 regnestykker! üß†",
        type: "math-sprint"
      },
      {
        title: "Hukommelses Spil - 10 Point",
        description: "Husk en sekvens af tal! üß†üî¢",
        type: "memory-game"
      },
      {
        title: "Blackjack - 10 Point",
        description: "Vind en h√•nd blackjack mod dealeren! üÉè",
        type: "blackjack"
      },
      {
        title: "Shot Hjulet - 5 Point",
        description: "Spin hjulet og drik hvad det lander p√•! üé∞ü•É",
        type: "shot-roulette"
      },
      {
        title: "Slotmaskine - 15 Point",
        description: "F√• tre ens p√• spilleautomaten! üé∞",
        type: "slot-machine"
      },
      {
        title: "Yatzy Challenge - 50 Point",
        description: "Sl√• yatzy med 5 terninger! üé≤",
        type: "yatzy-challenge"
      },
      {
        title: "Reaktionstest - 10 Point",
        description: "Tryk n√•r sk√¶rmen bliver gr√∏n - under 150ms! ‚ö°",
        type: "reaction-test"
      },
      {
        title: "Ord Scramble - 10 Point",
        description: "G√¶t 5 blandede ord! üî§",
        type: "word-scramble"
      },
      {
        title: "G√•de Udfordring - 10 Point",
        description: "L√∏s 3 g√•der! üß©",
        type: "riddle-challenge"
      }
    ];

    // ===== SCOREBOARD FUNCTIONS =====

    function loadData() {
      const saved = localStorage.getItem("scoreboardData");
      if (saved) {
        try {
          teams = JSON.parse(saved);
        } catch (e) {
          console.error("Kunne ikke indl√¶se data");
        }
      }
      const savedTasks = localStorage.getItem("completedTasks");
      if (savedTasks) {
        try {
          completedTasks = JSON.parse(savedTasks);
        } catch (e) {
          console.error("Kunne ikke indl√¶se opgaver");
        }
      }
    }

    function saveData() {
      localStorage.setItem("scoreboardData", JSON.stringify(teams));
      localStorage.setItem("completedTasks", JSON.stringify(completedTasks));
    }

    function renderScoreboard() {
      const sb = document.getElementById("scoreboard");
      sb.innerHTML = "";

      teams.forEach((team, idx) => {
        const teamDiv = document.createElement("div");
        teamDiv.className = "team";
        teamDiv.innerHTML = `
          <div class="team-name" onclick="editTeamName(${idx})">${team.name}</div>
          <div class="team-score">
            <button class="score-btn" onclick="changeScore(${idx}, -1)">‚àí</button>
            <div class="score-display" onclick="editScore(${idx})">${team.score}</div>
            <button class="score-btn" onclick="changeScore(${idx}, 1)">+</button>
          </div>
        `;
        sb.appendChild(teamDiv);
      });
    }

    function changeScore(idx, delta) {
      currentTeamIndex = idx;
      editType = 'scoreChange';
      // Store the delta for later use
      changeScore.delta = delta;
      showPinModal(delta > 0 ? "Indtast PIN for at tilf√∏je point" : "Indtast PIN for at fjerne point");
    }

    function editScore(idx) {
      console.log('editScore called for team:', idx);
      currentTeamIndex = idx;
      editType = 'score';
      showPinModal("Indtast PIN for at √¶ndre point");
    }

    function editTeamName(idx) {
      console.log('editTeamName called for team:', idx);
      currentTeamIndex = idx;
      editType = 'name';
      showPinModal("Indtast PIN for at √¶ndre holdnavn");
    }

    function resetScores() {
      currentAction = () => {
        if (confirm("Er du sikker p√• at du vil nulstille alle point?")) {
          teams.forEach(t => t.score = 0);
          saveData();
          renderScoreboard();
        }
      };
      currentTeamIndex = null;
      showPinModal("Indtast PIN for at nulstille");
    }

    function resetTasks() {
      currentAction = () => {
        if (confirm("Er du sikker p√• at du vil nulstille alle opgaver?")) {
          completedTasks = [];

          // Clear all team task tracking
          teams.forEach((team, index) => {
            localStorage.removeItem(`team_${index}_tasks`);
          });

          // Clear all shot roulette completions and device associations
          const keysToRemove = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.startsWith("shot_played_") || key.startsWith("device_team_"))) {
              keysToRemove.push(key);
            }
          }
          keysToRemove.forEach(key => localStorage.removeItem(key));

          saveData();
          renderTaskGrid();
          showTasksOverview();
          updateTeamProgressTracker();
        }
      };
      currentTeamIndex = null;
      showPinModal("Indtast PIN for at nulstille opgaver");
    }

    function showPinModal(title) {
      document.getElementById("modalTitle").textContent = title;
      document.getElementById("pinInput").value = "";
      document.getElementById("errorMsg").textContent = "";
      document.getElementById("pinModal").classList.add("show");
      document.getElementById("pinInput").focus();
    }

    function closeModal() {
      document.getElementById("pinModal").classList.remove("show");
      currentAction = null;
      currentTeamIndex = null;
      editType = null;
    }

    function showEditModal(title, currentValue, type) {
      console.log('showEditModal called:', title, currentValue, type);
      console.log('currentTeamIndex before showEditModal:', currentTeamIndex);

      // DON'T reassign - currentTeamIndex and editType are already set before calling this
      // Just use them as-is

      console.log('After setting - editType:', editType, 'currentTeamIndex:', currentTeamIndex);

      const editModal = document.getElementById("editModal");
      const editInput = document.getElementById("editInput");

      document.getElementById("editModalTitle").textContent = title;
      editInput.value = currentValue;

      if (type === 'score' || type === 'scoreChange') {
        editInput.type = 'number';
        editInput.min = '0';
      } else {
        editInput.type = 'text';
      }

      editModal.classList.add("show");
      console.log('Edit modal visible, editType:', editType, 'currentTeamIndex:', currentTeamIndex);

      setTimeout(() => {
        editInput.focus();
        editInput.select();
      }, 50);
    }

    function closeEditModal() {
      document.getElementById("editModal").classList.remove("show");
      currentTeamIndex = null;
      editType = null;
    }

    function saveEdit() {
      console.log('saveEdit called, editType:', editType, 'currentTeamIndex:', currentTeamIndex);
      const value = document.getElementById("editInput").value;
      console.log('Input value:', value);

      if (editType === 'name' && value.trim()) {
        console.log('Saving team name');
        teams[currentTeamIndex].name = value.trim();
        saveData();
        renderScoreboard();
        closeEditModal();
      } else if (editType === 'score') {
        const num = parseInt(value);
        console.log('Parsed score:', num);
        if (!isNaN(num) && num >= 0) {
          console.log('Saving team score');
          teams[currentTeamIndex].score = num;
          saveData();
          renderScoreboard();
          closeEditModal();
        }
      } else if (editType === 'scoreChange') {
        const amount = parseInt(value);
        console.log('Parsed score change amount:', amount);
        if (!isNaN(amount) && amount > 0) {
          const delta = changeScore.delta;
          console.log('Delta:', delta, 'applying change');
          if (delta > 0) {
            teams[currentTeamIndex].score += amount;
          } else {
            teams[currentTeamIndex].score = Math.max(0, teams[currentTeamIndex].score - amount);
          }
          saveData();
          renderScoreboard();
          closeEditModal();
        }
      } else {
        console.log('No valid save condition met');
      }
    }

    function verifyPin() {
      const input = document.getElementById("pinInput").value;

      // Check if already processing
      if (verifyPin.isProcessing) {
        console.log('Already processing, ignoring duplicate call');
        return;
      }

      console.log('Verifying PIN, editType:', editType, 'currentTeamIndex:', currentTeamIndex);

      if (input === PIN) {
        verifyPin.isProcessing = true;

        // Save editType and currentTeamIndex before closing modal
        const savedEditType = editType;
        const savedTeamIndex = currentTeamIndex;
        const savedAction = currentAction;

        console.log('Saved values - editType:', savedEditType, 'teamIndex:', savedTeamIndex, 'hasAction:', !!savedAction);

        closeModal();

        // Use setTimeout to ensure modal closes before opening edit modal
        setTimeout(() => {
          console.log('Inside setTimeout - editType:', savedEditType, 'teamIndex:', savedTeamIndex);
          if (savedAction) {
            console.log('Executing currentAction');
            savedAction();
          }
          else if (savedEditType === 'name') {
            console.log('Opening name edit modal for team:', savedTeamIndex);
            // Set currentTeamIndex before calling showEditModal
            currentTeamIndex = savedTeamIndex;
            editType = savedEditType;
            showEditModal(`Rediger ${teams[savedTeamIndex].name}`, teams[savedTeamIndex].name, savedEditType);
          } else if (savedEditType === 'score') {
            console.log('Opening score edit modal for team:', savedTeamIndex);
            // Set currentTeamIndex before calling showEditModal
            currentTeamIndex = savedTeamIndex;
            editType = savedEditType;
            showEditModal(`Rediger point for ${teams[savedTeamIndex].name}`, teams[savedTeamIndex].score, savedEditType);
          } else if (savedEditType === 'scoreChange') {
            console.log('Opening score change modal for team:', savedTeamIndex);
            // Set currentTeamIndex before calling showEditModal
            currentTeamIndex = savedTeamIndex;
            editType = savedEditType;
            const delta = changeScore.delta;
            const action = delta > 0 ? 'Tilf√∏j' : 'Fjern';
            showEditModal(`${action} point for ${teams[savedTeamIndex].name}`, Math.abs(delta), savedEditType);
          } else {
            console.log('No matching condition - savedEditType:', savedEditType, 'savedAction:', savedAction);
          }

          verifyPin.isProcessing = false;
        }, 150);
      } else {
        document.getElementById("errorMsg").textContent = "Forkert PIN - pr√∏v igen";
        document.getElementById("pinInput").value = "";
        document.getElementById("pinInput").focus();
      }
    }    // ===== TASK FUNCTIONS =====

    function renderTaskGrid() {
      const grid = document.getElementById("taskGrid");
      grid.innerHTML = "";

      tasks.forEach((task, idx) => {
        if (completedTasks.includes(idx)) return; // Skip completed tasks

        const card = document.createElement("div");
        card.className = "task-card";
        card.onclick = () => openTask(idx);

        card.innerHTML = `
          <div class="task-card-number">Opgave ${idx + 1}</div>
          <div class="task-card-title">${task.title}</div>
          <div class="task-card-description">${task.description}</div>
        `;

        grid.appendChild(card);
      });

      if (completedTasks.length === tasks.length) {
        grid.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: var(--muted);"><div style="font-size: 48px; margin-bottom: 16px;">üéâ</div><div style="font-size: 24px; font-weight: 600;">Alle opgaver gennemf√∏rt!</div><div style="margin-top: 12px;">Tryk "Nulstil Opgaver" for at starte forfra</div></div>';
      }
    }

    function openTask(index) {
      if (completedTasks.includes(index)) {
        alert("Denne opgave er allerede gennemf√∏rt!");
        return;
      }
      // Clear any active timers from previous task
      activeTimers.forEach(timer => clearInterval(timer));
      activeTimers = [];

      currentTaskIndex = index;
      document.getElementById("tasksOverview").classList.add("hidden");
      document.getElementById("taskDetail").classList.add("active");
      renderTask();
    }

    function showTasksOverview() {
      // Clear any active timers
      activeTimers.forEach(timer => clearInterval(timer));
      activeTimers = [];

      document.getElementById("taskDetail").classList.remove("active");
      document.getElementById("tasksOverview").classList.remove("hidden");
    }

    function completeTask(taskIndex) {
      if (!completedTasks.includes(taskIndex)) {
        completedTasks.push(taskIndex);

        // Track this task completion for current team
        const currentTeam = localStorage.getItem("current_team_index");
        if (currentTeam !== null) {
          const teamTasksKey = `team_${currentTeam}_tasks`;
          let teamTasks = JSON.parse(localStorage.getItem(teamTasksKey) || '[]');
          if (!teamTasks.includes(taskIndex)) {
            teamTasks.push(taskIndex);
            localStorage.setItem(teamTasksKey, JSON.stringify(teamTasks));
          }
        }

        saveData();
        renderTaskGrid();
        showTasksOverview();
        updateTeamProgressTracker();
      }
    }

    function renderTask() {
      const task = tasks[currentTaskIndex];
      document.getElementById("taskCounter").textContent = `Opgave ${currentTaskIndex + 1}/${tasks.length}`;
      document.getElementById("taskTitle").textContent = task.title;
      document.getElementById("taskDescription").textContent = task.description;

      const content = document.getElementById("taskContent");

      switch (task.type) {
        case "emoji-songs":
          renderEmojiSongsTask(content);
          break;
        case "click-challenge":
          renderClickChallengeTask(content);
          break;
        case "beer-pong":
          renderBeerPongTask(content);
          break;
        case "physiology-quiz":
          renderPhysiologyQuizTask(content);
          break;
        case "trick-host":
          renderTrickHostTask(content);
          break;
        case "straw-challenge":
          renderStrawChallengeTask(content);
          break;
        case "beerbong-challenge":
          renderBeerBongTask(content);
          break;
        case "strava-run":
          renderStravaRunTask(content);
          break;
        case "math-sprint":
          renderMathSprintTask(content);
          break;
        case "memory-game":
          renderMemoryGameTask(content);
          break;
        case "blackjack":
          renderBlackjackTask(content);
          break;
        case "shot-roulette":
          renderShotRouletteTask(content);
          break;
        case "slot-machine":
          renderSlotMachineTask(content);
          break;
        case "yatzy-challenge":
          renderYatzyChallengeTask(content);
          break;
        case "reaction-test":
          renderReactionTestTask(content);
          break;
        case "word-scramble":
          renderWordScrambleTask(content);
          break;
        case "riddle-challenge":
          renderRiddleChallengeTask(content);
          break;
        default:
          content.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--muted);">
              <p style="font-size: 20px;">Denne opgave er endnu ikke tilg√¶ngelig</p>
            </div>
          `;
          document.getElementById("taskStatus").textContent = "Ikke tilg√¶ngelig";
      }
    }

    function nextTask() {
      if (currentTaskIndex < tasks.length - 1) {
        currentTaskIndex++;
        renderTask();
      }
    }

    function previousTask() {
      if (currentTaskIndex > 0) {
        currentTaskIndex--;
        renderTask();
      }
    }

    // ===== TASK RENDERS =====

    // 1. EMOJI SONGS TASK
    function renderEmojiSongsTask(container) {
      const songs = [
        { emoji: "üÉèüé∞üòê", answer: "pokerface", title: "Pokerface - Lady Gaga" },
        { emoji: "‚ö°üå©Ô∏èüí•", answer: "thunderstruck", title: "Thunderstruck - AC/DC" },
        { emoji: "üó∫Ô∏èüìçüß≠", answer: "maps", title: "Maps - Maroon 5" },
        { emoji: "üîüüìÖ‚è∞", answer: "10 √•r", title: "10 √•r - Emil Lange" },
        { emoji: "üí°üî¶‚ú®", answer: "skarpt lys", title: "Skarpt Lys - Gilli" },
        { emoji: "üèóÔ∏èüö®‚ö†Ô∏è", answer: "kranalarm", title: "Kranalarm - Jesubr√∏dre" },
        { emoji: "üç¨üé®üñåÔ∏è", answer: "candy paint", title: "Candy Paint - Post Malone" },
        { emoji: "üá©üá™üñ§‚ù§Ô∏èüíõ", answer: "deutschland", title: "Deutschland - Rammstein" },
        { emoji: "üíÉüëëüéµ", answer: "dancing queen", title: "Dancing Queen - ABBA" },
        { emoji: "üïäÔ∏è‚òÆÔ∏èü§ù", answer: "fred", title: "Fred - Bo Evers" }
      ];

      let currentS = 0;
      let answered = false;

      function render() {
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 20px;">
              Sang ${currentS + 1}/${songs.length}
            </div>
            <div style="font-size: 64px; margin: 30px 0;">
              ${songs[currentS].emoji}
            </div>
            
            ${!answered ? `
              <div style="max-width: 400px; margin: 20px auto;">
                <input 
                  type="text" 
                  id="songGuess" 
                  placeholder="Skriv dit g√¶t her..." 
                  style="width: 100%; padding: 16px; font-size: 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); text-align: center;"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();emojiCheckGuess();}"
                >
              </div>
              <button class="btn primary" onclick="emojiCheckGuess()" style="margin-top: 20px;">Tjek svar</button>
            ` : `
              <div style="font-size: 20px; margin: 20px 0; min-height: 60px; color: var(--ok);">
                ‚úì Korrekt! üéµ ${songs[currentS].title}
              </div>
              <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                ${currentS < songs.length - 1 ? '<button class="btn primary" onclick="emojiNext()">N√¶ste ‚Üí</button>' : '<button class="btn primary" onclick="emojiFinish()">F√¶rdig! ‚úì</button>'}
              </div>
            `}
          </div>
        `;
        if (!answered) {
          setTimeout(() => document.getElementById("songGuess")?.focus(), 100);
        }
      }

      window.emojiCheckGuess = () => {
        const guess = document.getElementById("songGuess")?.value.toLowerCase().trim() || '';
        const answer = songs[currentS].answer.toLowerCase().trim();

        console.log('Guess:', guess, 'Answer:', answer, 'Match:', guess === answer);

        // Check if guess matches the answer exactly
        if (guess === answer) {
          answered = true;
          render();
        } else {
          // Wrong answer - shake the input or show error
          const input = document.getElementById("songGuess");
          if (input) {
            input.style.borderColor = 'var(--bad)';
            input.value = '';
            input.placeholder = 'Forkert - pr√∏v igen!';
            setTimeout(() => {
              input.style.borderColor = '';
              input.placeholder = 'Skriv dit g√¶t her...';
            }, 1500);
          }
        }
      }; window.emojiNext = () => { if (currentS < songs.length - 1) { currentS++; answered = false; render(); } };
      window.emojiFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px; margin-bottom: 16px;">üéµ</div><div style="font-size: 24px; font-weight: 600;">Alle sange gennemg√•et!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "I gang";
    }

    // 2. CLICK CHALLENGE TASK
    function renderClickChallengeTask(container) {
      let clicks = 0;
      let timeLeft = 10;
      let timerInterval = null;
      let started = false;

      function render() {
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 20px;">
              Tryk p√• knappen mere end 75 gange p√• 10 sekunder!
            </div>
            
            <div style="font-size: 80px; font-weight: 700; color: var(--accent); margin: 30px 0;">
              ${clicks}
            </div>
            
            <div style="font-size: 32px; font-weight: 600; margin: 20px 0; color: ${timeLeft <= 3 ? 'var(--bad)' : 'var(--text)'};">
              ${timeLeft}s
            </div>
            
            ${!started ? `
              <button class="btn primary" onclick="startClicking()" style="font-size: 20px; padding: 20px 40px; margin-top: 20px;">
                Start! üöÄ
              </button>
            ` : timeLeft > 0 ? `
              <button class="btn primary" onclick="incrementClick()" style="font-size: 24px; padding: 30px 60px; margin-top: 20px;">
                KLIK! üñ±Ô∏è
              </button>
            ` : `
              <div style="margin-top: 30px;">
                ${clicks >= 75 ? `
                  <div style="font-size: 28px; color: var(--ok); margin-bottom: 20px;">
                    ‚úÖ Du klarede det! ${clicks} klik!
                  </div>
                  <button class="btn primary" onclick="clickFinish()">Forts√¶t ‚Üí</button>
                ` : `
                  <div style="font-size: 28px; color: var(--bad); margin-bottom: 20px;">
                    ‚ùå Ikke nok klik! Kun ${clicks}/75
                  </div>
                  <button class="btn" onclick="clickRetry()">Pr√∏v igen</button>
                `}
              </div>
            `}
          </div>
        `;
      }

      window.startClicking = () => {
        started = true;
        clicks = 0;
        timeLeft = 10;
        render();

        timerInterval = setInterval(() => {
          timeLeft--;
          render();

          if (timeLeft <= 0) {
            clearInterval(timerInterval);
          }
        }, 1000);
      };

      window.incrementClick = () => {
        if (timeLeft > 0) {
          clicks++;
          render();
        }
      };

      window.clickRetry = () => {
        started = false;
        clicks = 0;
        timeLeft = 10;
        if (timerInterval) clearInterval(timerInterval);
        render();
      };

      window.clickFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px; margin-bottom: 16px;">üñ±Ô∏è</div><div style="font-size: 24px; font-weight: 600;">Klik-udfordring gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar";
    }

    // 3. BEER PONG TASK
    function renderBeerPongTask(container) {
      let verified = false;

      function render() {
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 30px; line-height: 1.4;">
              Kast en beer pong bold i koppen 4 gange i streg! üç∫
            </div>
            
            <div style="font-size: 64px; margin: 40px 0;">
              üèì ‚Üí ü•§
            </div>
            
            <div style="font-size: 18px; color: var(--muted); margin: 30px 20px; line-height: 1.6;">
              N√•r I har klaret udfordringen, skal v√¶rten indtaste PIN-koden for at bekr√¶fte.
            </div>
            
            ${!verified ? `
              <div style="margin-top: 40px;">
                <input 
                  type="password" 
                  id="beerPongPin" 
                  placeholder="Indtast PIN..." 
                  style="width: 200px; padding: 16px; font-size: 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); text-align: center; margin-bottom: 12px;"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();verifyBeerPong();}"
                >
                <div id="beerPongError" style="color: var(--bad); font-size: 14px; min-height: 20px; margin-bottom: 12px;"></div>
                <button class="btn primary" onclick="verifyBeerPong()">Bekr√¶ft ‚úì</button>
              </div>
            ` : `
              <div style="margin-top: 40px;">
                <div style="font-size: 28px; color: var(--ok); margin-bottom: 20px;">
                  ‚úÖ Bekr√¶ftet af v√¶rt!
                </div>
                <button class="btn primary" onclick="beerPongFinish()">Forts√¶t ‚Üí</button>
              </div>
            `}
          </div>
        `;
        if (!verified) {
          setTimeout(() => document.getElementById("beerPongPin")?.focus(), 100);
        }
      }

      window.verifyBeerPong = () => {
        const input = document.getElementById("beerPongPin")?.value || '';
        const errorDiv = document.getElementById("beerPongError");

        if (input === PIN) {
          verified = true;
          render();
        } else {
          errorDiv.textContent = "Forkert PIN - pr√∏v igen";
          document.getElementById("beerPongPin").value = "";
          setTimeout(() => {
            errorDiv.textContent = "";
          }, 2000);
        }
      };

      window.beerPongFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px; margin-bottom: 16px;">üç∫</div><div style="font-size: 24px; font-weight: 600;">Beer Pong udfordring gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar til at starte";
    }

    // 4. PHYSIOLOGY QUIZ TASK
    function renderPhysiologyQuizTask(container) {
      const questions = [
        {
          q: "Hvad er det normale hvile-hjerterate for en voksen?",
          answer: "60-100",
          hint: "Angiv som interval"
        },
        {
          q: "Hvor mange liter blod pumper hjertet cirka per minut i hvile?",
          answer: "5",
          hint: ""
        },
        {
          q: "Hvad hedder det protein i r√∏de blodlegemer der transporterer ilt?",
          answer: "h√¶moglobin",
          hint: ""
        },
        {
          q: "Hvor mange kranienervepar har mennesket?",
          answer: "12",
          hint: ""
        },
        {
          q: "Hvad er det normale pH-niveau i blodet?",
          answer: "7.4",
          hint: ""
        }
      ];

      let currentQ = 0;
      let answered = false;

      function render() {
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 20px;">
              Sp√∏rgsm√•l ${currentQ + 1}/${questions.length}
            </div>
            <div style="font-size: 22px; font-weight: 600; margin-bottom: 30px; line-height: 1.4;">
              ${questions[currentQ].q}
            </div>
            
            ${!answered ? `
              <div style="max-width: 400px; margin: 20px auto;">
                <div style="font-size: 14px; color: var(--muted); margin-bottom: 8px;">
                  ${questions[currentQ].hint}
                </div>
                <input 
                  type="text" 
                  id="physioAnswer" 
                  placeholder="Dit svar..." 
                  style="width: 100%; padding: 16px; font-size: 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); text-align: center;"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();checkPhysioAnswer();}"
                >
              </div>
              <button class="btn primary" onclick="checkPhysioAnswer()" style="margin-top: 20px;">Tjek svar</button>
            ` : `
              <div style="font-size: 20px; margin: 20px 0; min-height: 60px; color: var(--ok);">
                ‚úì Korrekt! Svaret er: ${questions[currentQ].answer}
              </div>
              <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                ${currentQ < questions.length - 1 ? '<button class="btn primary" onclick="physioNext()">N√¶ste ‚Üí</button>' : '<button class="btn primary" onclick="physioFinish()">F√¶rdig! ‚úì</button>'}
              </div>
            `}
          </div>
        `;
        if (!answered) {
          setTimeout(() => document.getElementById("physioAnswer")?.focus(), 100);
        }
      }

      window.checkPhysioAnswer = () => {
        const guess = document.getElementById("physioAnswer")?.value.toLowerCase().trim() || '';
        const answer = questions[currentQ].answer.toLowerCase().trim();

        console.log('Guess:', guess, 'Answer:', answer, 'Match:', guess === answer);

        // Check if guess matches the answer exactly
        if (guess === answer) {
          answered = true;
          render();
        } else {
          // Wrong answer - shake the input
          const input = document.getElementById("physioAnswer");
          if (input) {
            input.style.borderColor = 'var(--bad)';
            input.value = '';
            input.placeholder = 'Forkert - pr√∏v igen!';
            setTimeout(() => {
              input.style.borderColor = '';
              input.placeholder = 'Dit svar...';
            }, 1500);
          }
        }
      };

      window.physioNext = () => {
        if (currentQ < questions.length - 1) {
          currentQ++;
          answered = false;
          render();
        }
      };

      window.physioFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px; margin-bottom: 16px;">üß†</div><div style="font-size: 24px; font-weight: 600;">Fysiologi quiz gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "I gang";
    }

    // 5. TRICK HOST TASK
    function renderTrickHostTask(container) {
      let verified = false;

      function render() {
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 30px; line-height: 1.4;">
              Snyd V√¶rten! ü•É
            </div>
            
            <div style="font-size: 18px; color: var(--text); margin: 30px 20px; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto;">
              <p style="margin-bottom: 16px;"><strong>S√•dan spiller I:</strong></p>
              <p style="margin-bottom: 12px;">1. V√¶lg en spiller der skal drikke</p>
              <p style="margin-bottom: 12px;">2. Spilleren v√¶lger HEMMELIGT mellem vand üíß eller sambuca ü•É</p>
              <p style="margin-bottom: 12px;">3. Spilleren drikker shottet og pr√∏ver at holde masken!</p>
              <p style="margin-bottom: 12px;">4. V√¶rten skal g√¶tte hvad der blev drukket</p>
              <p style="margin-bottom: 12px;">5. N√•r v√¶rten har g√¶ttet, indtaster v√¶rten PIN-koden</p>
            </div>
            
            <div style="font-size: 64px; margin: 40px 0;">
              üíß eller ü•É ?
            </div>
            
            ${!verified ? `
              <div style="margin-top: 40px;">
                <div style="font-size: 18px; color: var(--muted); margin-bottom: 20px;">
                  V√¶rt: Har du g√¶ttet rigtigt? Indtast PIN for at bekr√¶fte
                </div>
                <input 
                  type="password" 
                  id="trickHostPin" 
                  placeholder="Indtast PIN..." 
                  style="width: 200px; padding: 16px; font-size: 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); text-align: center; margin-bottom: 12px;"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();verifyTrickHost();}"
                >
                <div id="trickHostError" style="color: var(--bad); font-size: 14px; min-height: 20px; margin-bottom: 12px;"></div>
                <button class="btn primary" onclick="verifyTrickHost()">Bekr√¶ft ‚úì</button>
              </div>
            ` : `
              <div style="margin-top: 40px;">
                <div style="font-size: 28px; color: var(--ok); margin-bottom: 20px;">
                  ‚úÖ V√¶rten har godkendt!
                </div>
                <button class="btn primary" onclick="trickHostFinish()">Forts√¶t ‚Üí</button>
              </div>
            `}
          </div>
        `;
        if (!verified) {
          setTimeout(() => document.getElementById("trickHostPin")?.focus(), 100);
        }
      }

      window.verifyTrickHost = () => {
        const input = document.getElementById("trickHostPin")?.value || '';
        const errorDiv = document.getElementById("trickHostError");

        if (input === PIN) {
          verified = true;
          render();
        } else {
          errorDiv.textContent = "Forkert PIN - pr√∏v igen";
          document.getElementById("trickHostPin").value = "";
          setTimeout(() => {
            errorDiv.textContent = "";
          }, 2000);
        }
      };

      window.trickHostFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px; margin-bottom: 16px;">ü•É</div><div style="font-size: 24px; font-weight: 600;">Snyd V√¶rten gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar til at snyde!";
    }

    // 6. STRAW CHALLENGE TASK
    function renderStrawChallengeTask(container) {
      let verified = false;

      function render() {
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 30px; line-height: 1.4;">
              Drik en √∏l gennem et suger√∏r! üç∫ü•§
            </div>
            
            <div style="font-size: 64px; margin: 40px 0;">
              üç∫ ‚Üí ü•§ ‚Üí üòµ‚Äçüí´
            </div>
            
            <div style="font-size: 18px; color: var(--text); margin: 30px 20px; line-height: 1.6;">
              En spiller skal drikke en hel √∏l gennem et suger√∏r!<br>
              V√¶rten bekr√¶fter med PIN n√•r opgaven er fuldf√∏rt.
            </div>
            
            ${!verified ? `
              <div style="margin-top: 40px;">
                <input 
                  type="password" 
                  id="strawPin" 
                  placeholder="Indtast PIN..." 
                  style="width: 200px; padding: 16px; font-size: 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); text-align: center; margin-bottom: 12px;"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();verifyStraw();}"
                >
                <div id="strawError" style="color: var(--bad); font-size: 14px; min-height: 20px; margin-bottom: 12px;"></div>
                <button class="btn primary" onclick="verifyStraw()">Bekr√¶ft ‚úì</button>
              </div>
            ` : `
              <div style="margin-top: 40px;">
                <div style="font-size: 28px; color: var(--ok); margin-bottom: 20px;">
                  ‚úÖ Bekr√¶ftet af v√¶rt!
                </div>
                <button class="btn primary" onclick="strawFinish()">Forts√¶t ‚Üí</button>
              </div>
            `}
          </div>
        `;
        if (!verified) {
          setTimeout(() => document.getElementById("strawPin")?.focus(), 100);
        }
      }

      window.verifyStraw = () => {
        const input = document.getElementById("strawPin")?.value || '';
        const errorDiv = document.getElementById("strawError");

        if (input === PIN) {
          verified = true;
          render();
        } else {
          errorDiv.textContent = "Forkert PIN - pr√∏v igen";
          document.getElementById("strawPin").value = "";
          setTimeout(() => {
            errorDiv.textContent = "";
          }, 2000);
        }
      };

      window.strawFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px; margin-bottom: 16px;">ü•§</div><div style="font-size: 24px; font-weight: 600;">Suger√∏rs challenge gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar til at drikke";
    }

    // 7. BEER BONG CHALLENGE TASK
    function renderBeerBongTask(container) {
      let verified = false;

      function render() {
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">
              √òlbong Challenge ‚ö°üç∫
            </div>
            
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px; line-height: 1.6;">
              Tag en √∏lbong p√• under 2,5 sekunder!<br>
              V√¶rten skal bekr√¶fte med pinkode n√•r det er gjort.
            </div>
            
            <div style="font-size: 64px; margin: 40px 0;">
              üç∫‚ö°
            </div>
            
            ${!verified ? `
              <div style="max-width: 300px; margin: 30px auto;">
                <div style="font-size: 18px; margin-bottom: 12px; color: var(--text);">
                  V√¶rt PIN-kode:
                </div>
                <input 
                  type="password" 
                  id="beerBongPin" 
                  placeholder="Indtast PIN" 
                  style="width: 100%; padding: 16px; font-size: 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); text-align: center;"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();verifyBeerBong();}"
                >
                <div id="beerBongError" style="color: var(--bad); margin-top: 12px; min-height: 24px;"></div>
                <button class="btn primary" onclick="verifyBeerBong()" style="margin-top: 20px; width: 100%;">Bekr√¶ft üç∫</button>
              </div>
            ` : `
              <div style="margin-top: 40px;">
                <div style="font-size: 28px; color: var(--ok); margin-bottom: 20px;">
                  ‚úÖ Bekr√¶ftet af v√¶rt!
                </div>
                <button class="btn primary" onclick="beerBongFinish()">Forts√¶t ‚Üí</button>
              </div>
            `}
          </div>
        `;
        if (!verified) {
          setTimeout(() => document.getElementById("beerBongPin")?.focus(), 100);
        }
      }

      window.verifyBeerBong = () => {
        const input = document.getElementById("beerBongPin")?.value || '';
        const errorDiv = document.getElementById("beerBongError");

        if (input === PIN) {
          verified = true;
          render();
        } else {
          errorDiv.textContent = "Forkert PIN - pr√∏v igen";
          document.getElementById("beerBongPin").value = "";
          setTimeout(() => {
            errorDiv.textContent = "";
          }, 2000);
        }
      };

      window.beerBongFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px; margin-bottom: 16px;">‚ö°üç∫</div><div style="font-size: 24px; font-weight: 600;">√òlbong challenge gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar til √∏lbong";
    }

    // 8. STRAVA RUN CHALLENGE TASK
    function renderStravaRunTask(container) {
      let verified = false;

      function render() {
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">
              Strava L√∏b Challenge üèÉ‚Äç‚ôÇÔ∏è
            </div>
            
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px; line-height: 1.6;">
              L√∏b en kilometer og vis bevis fra Strava!<br>
              V√¶rten skal bekr√¶fte med pinkode n√•r det er gjort.
            </div>
            
            <div style="font-size: 64px; margin: 40px 0;">
              üèÉ‚Äç‚ôÇÔ∏èüì±
            </div>
            
            ${!verified ? `
              <div style="max-width: 300px; margin: 30px auto;">
                <div style="font-size: 18px; margin-bottom: 12px; color: var(--text);">
                  V√¶rt PIN-kode:
                </div>
                <input 
                  type="password" 
                  id="stravaPin" 
                  placeholder="Indtast PIN" 
                  style="width: 100%; padding: 16px; font-size: 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); text-align: center;"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();verifyStrava();}"
                >
                <div id="stravaError" style="color: var(--bad); margin-top: 12px; min-height: 24px;"></div>
                <button class="btn primary" onclick="verifyStrava()" style="margin-top: 20px; width: 100%;">‚úÖ Bekr√¶ft l√∏b</button>
              </div>
            ` : `
              <div style="margin-top: 40px;">
                <div style="font-size: 28px; color: var(--ok); margin-bottom: 20px;">
                  ‚úÖ Bekr√¶ftet af v√¶rt!
                </div>
                <button class="btn primary" onclick="stravaFinish()">Forts√¶t ‚Üí</button>
              </div>
            `}
          </div>
        `;
        if (!verified) {
          setTimeout(() => document.getElementById("stravaPin")?.focus(), 100);
        }
      }

      window.verifyStrava = () => {
        const input = document.getElementById("stravaPin")?.value || '';
        const errorDiv = document.getElementById("stravaError");

        if (input === PIN) {
          verified = true;
          render();
        } else {
          errorDiv.textContent = "Forkert PIN - pr√∏v igen";
          document.getElementById("stravaPin").value = "";
          setTimeout(() => {
            errorDiv.textContent = "";
          }, 2000);
        }
      };

      window.stravaFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px; margin-bottom: 16px;">üèÉ‚Äç‚ôÇÔ∏èüèÜ</div><div style="font-size: 24px; font-weight: 600;">Strava l√∏b gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar til at l√∏be";
    }

    // 9. YATZY CHALLENGE TASK
    function renderYatzyChallengeTask(container) {
      let dice = [null, null, null, null, null];
      let rolling = false;
      let attempts = 0;

      function rollDice() {
        if (rolling) return;
        rolling = true;
        attempts++;

        let rollCount = 0;
        const rollInterval = setInterval(() => {
          dice = dice.map(() => Math.floor(Math.random() * 6) + 1);
          render();
          rollCount++;

          if (rollCount >= 10) {
            clearInterval(rollInterval);
            rolling = false;
            checkYatzy();
            render();
          }
        }, 100);
      }

      function checkYatzy() {
        if (dice.some(d => d === null)) return false;
        const allSame = dice.every(d => d === dice[0]);
        return allSame;
      }

      function render() {
        const isYatzy = checkYatzy();
        const diceEmojis = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];

        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">
              Sl√• Yatzy med 5 terninger! üé≤
            </div>
            
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px;">
              Alle 5 terninger skal vise samme v√¶rdi!
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin: 40px 0;">
              ${dice.map(d => `<div style="font-size: 64px;">${d === null ? '‚ùì' : diceEmojis[d - 1]}</div>`).join('')}
            </div>
            
            ${isYatzy && !rolling ? `
              <div style="font-size: 28px; color: var(--ok); margin: 30px 0; font-weight: 600;">
                üéâ YATZY! Du klarede det p√• ${attempts} fors√∏g!
              </div>
              <button class="btn primary" onclick="yatzyFinish()">Forts√¶t ‚Üí</button>
            ` : `
              <div style="font-size: 18px; color: var(--muted); margin: 20px 0;">
                Fors√∏g: ${attempts}
              </div>
              <button class="btn primary" onclick="rollYatzy()" ${rolling ? 'disabled' : ''} style="font-size: 20px; padding: 20px 40px;">
                ${rolling ? 'Ruller...' : 'üé≤ Sl√• terningerne!'}
              </button>
            `}
          </div>
        `;
      }

      window.rollYatzy = rollDice;


      window.yatzyReset = () => {
        dice = [null, null, null, null, null];
        rolling = false;
        attempts = 0;
        render();
      }; window.yatzyFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px; margin-bottom: 16px;">üé≤</div><div style="font-size: 24px; font-weight: 600;">Yatzy challenge gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar til at rulle";
    }

    // 10. REACTION TEST TASK
    function renderReactionTestTask(container) {
      let gameState = 'waiting'; // waiting, ready, go, clicked, too-early
      let startTime = 0;
      let reactionTime = 0;
      let attempts = 0;
      let bestTime = Infinity;
      const maxAttempts = 3;
      const targetTime = 150; // 150ms to win

      function startTest() {
        if (gameState === 'ready' || gameState === 'go') return;

        gameState = 'ready';
        attempts++;
        render();

        // Random delay between 2-5 seconds
        const delay = 2000 + Math.random() * 3000;

        setTimeout(() => {
          if (gameState === 'ready') { // Check if not clicked early
            gameState = 'go';
            startTime = Date.now();
            render();
          }
        }, delay);
      }

      function handleClick() {
        if (gameState === 'ready') {
          // Clicked too early
          gameState = 'too-early';
          render();
        } else if (gameState === 'go') {
          // Valid click
          reactionTime = Date.now() - startTime;
          if (reactionTime < bestTime) {
            bestTime = reactionTime;
          }
          gameState = 'clicked';
          render();
        }
      }

      function render() {
        const won = bestTime <= targetTime;

        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">
              ‚ö° Reaktionstest
            </div>
            
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px;">
              Tryk n√•r sk√¶rmen bliver gr√∏n!<br>
              Du har ${maxAttempts} fors√∏g - f√• under ${targetTime}ms for at vinde
            </div>

            ${gameState === 'waiting' ? `
              <div style="margin: 40px 0;">
                <div style="font-size: 18px; color: var(--muted); margin-bottom: 20px;">
                  Fors√∏g: ${attempts}/${maxAttempts}
                  ${bestTime < Infinity ? `<br>Bedste tid: ${bestTime}ms` : ''}
                </div>
                <button class="btn primary" onclick="reactionStart()" style="font-size: 20px; padding: 20px 40px;">
                  üöÄ Start Test
                </button>
              </div>
            ` : gameState === 'ready' ? `
              <div 
                onclick="reactionClick()"
                style="
                  background: #ff5c7a;
                  width: 100%;
                  max-width: 500px;
                  height: 300px;
                  margin: 40px auto;
                  border-radius: 20px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 32px;
                  font-weight: 700;
                  color: white;
                  cursor: pointer;
                  user-select: none;
                  box-shadow: 0 8px 24px rgba(255, 92, 122, 0.3);
                "
              >
                VENT...
              </div>
              <div style="font-size: 16px; color: var(--muted);">
                Vent p√• gr√∏n!
              </div>
            ` : gameState === 'go' ? `
              <div 
                onclick="reactionClick()"
                style="
                  background: #24d18f;
                  width: 100%;
                  max-width: 500px;
                  height: 300px;
                  margin: 40px auto;
                  border-radius: 20px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 32px;
                  font-weight: 700;
                  color: white;
                  cursor: pointer;
                  user-select: none;
                  box-shadow: 0 8px 24px rgba(36, 209, 143, 0.3);
                  animation: pulse 0.5s infinite;
                "
              >
                KLIK NU!
              </div>
              <style>
                @keyframes pulse {
                  0%, 100% { transform: scale(1); }
                  50% { transform: scale(1.05); }
                }
              </style>
            ` : gameState === 'too-early' ? `
              <div style="margin: 40px 0;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                <div style="font-size: 28px; color: var(--bad); margin-bottom: 20px; font-weight: 600;">
                  For tidligt!
                </div>
                <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px;">
                  Vent til sk√¶rmen bliver gr√∏n
                </div>
                ${attempts < maxAttempts ? `
                  <button class="btn primary" onclick="reactionReset()">Pr√∏v igen (${attempts}/${maxAttempts})</button>
                ` : `
                  <div style="font-size: 20px; color: var(--bad); margin: 20px 0;">
                    Ingen flere fors√∏g!
                  </div>
                  <button class="btn" onclick="showTasksOverview()">Tilbage til opgaver</button>
                `}
              </div>
            ` : `
              <div style="margin: 40px 0;">
                <div style="font-size: 80px; margin-bottom: 20px;">${won ? 'üèÜ' : '‚è±Ô∏è'}</div>
                <div style="font-size: 32px; color: ${won ? 'var(--ok)' : 'var(--accent)'}; margin-bottom: 20px; font-weight: 700;">
                  ${reactionTime}ms
                </div>
                <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px;">
                  ${won ? `Fantastisk! Under ${targetTime}ms!` : `Ikke hurtigt nok - pr√∏v igen!`}
                  ${bestTime < Infinity ? `<br>Bedste tid: ${bestTime}ms` : ''}
                </div>
                ${won ? `
                  <button class="btn primary" onclick="reactionFinish()">Forts√¶t ‚Üí</button>
                ` : attempts < maxAttempts ? `
                  <button class="btn primary" onclick="reactionReset()">Pr√∏v igen (${attempts}/${maxAttempts})</button>
                ` : `
                  <div style="font-size: 20px; color: var(--bad); margin: 20px 0;">
                    Ingen flere fors√∏g!<br>
                    Bedste tid: ${bestTime}ms
                  </div>
                  <button class="btn" onclick="showTasksOverview()">Tilbage til opgaver</button>
                `}
              </div>
            `}
          </div>
        `;
      }

      window.reactionStart = startTest;
      window.reactionClick = handleClick;
      window.reactionReset = () => {
        gameState = 'waiting';
        reactionTime = 0;
        render();
      };
      window.reactionFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 16px;">‚ö°</div><div style="font-size: 24px; font-weight: 600;">Reaktionstest gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar til test";
    }

    // 16. WORD SCRAMBLE TASK
    function renderWordScrambleTask(container) {
      const words = [
        { original: 'JULEFROKOST', scrambled: 'UJOTRESOFKL' },
        { original: 'HOREBUKKENE', scrambled: 'ERBENKKOHEU' },
        { original: 'SIXSEVEN', scrambled: 'EINSVESX' },
        { original: 'BANELEDDET', scrambled: 'TEDALENEBD' },
        { original: 'HADERPERKERNE', scrambled: 'DRENKRPAHEERE' }
      ];

      let currentWord = 0;
      let solved = 0;

      function render() {
        if (currentWord >= words.length) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>
              <div style="font-size: 32px; color: var(--ok); margin-bottom: 20px; font-weight: 700;">
                Alle ${words.length} ord g√¶ttet!
              </div>
              <button class="btn primary" onclick="wordScrambleFinish()" style="padding: 16px 32px;">Forts√¶t ‚Üí</button>
            </div>
          `;
          return;
        }

        const word = words[currentWord];
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 600; margin-bottom: 30px;">
              üî§ Ord Scramble
            </div>
            
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px;">
              G√¶t ordet ud fra de blandede bogstaver!
            </div>

            <div style="font-size: 20px; color: var(--accent); margin-bottom: 20px;">
              Ord ${currentWord + 1} af ${words.length}
            </div>
            
            <div style="
              background: var(--card);
              padding: 40px;
              border-radius: 16px;
              margin: 30px auto;
              max-width: 500px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            ">
              <div style="font-size: 48px; font-weight: 700; letter-spacing: 8px; color: var(--accent); margin-bottom: 30px;">
                ${word.scrambled}
              </div>
              
              <input 
                type="text" 
                id="wordGuess"
                placeholder="Dit g√¶t..."
                style="
                  width: 100%;
                  padding: 16px;
                  font-size: 20px;
                  text-align: center;
                  border: 2px solid var(--border);
                  border-radius: 8px;
                  background: var(--bg);
                  color: var(--text);
                  text-transform: uppercase;
                  letter-spacing: 2px;
                  box-sizing: border-box;
                "
                onkeypress="if(event.key === 'Enter') wordScrambleCheck()"
              />
            </div>
            
            <button class="btn primary" onclick="wordScrambleCheck()" style="font-size: 20px; padding: 16px 40px;">
              Tjek svar
            </button>
            
            ${solved > 0 ? `
              <div style="margin-top: 30px; font-size: 18px; color: var(--ok);">
                ‚úÖ ${solved} ord l√∏st
              </div>
            ` : ''}
          </div>
        `;

        setTimeout(() => {
          const input = document.getElementById('wordGuess');
          if (input) input.focus();
        }, 100);
      }

      window.wordScrambleCheck = () => {
        const input = document.getElementById('wordGuess');
        const guess = input.value.toUpperCase().trim();
        const word = words[currentWord];

        if (guess === word.original) {
          solved++;
          currentWord++;
          render();
        } else {
          // Visual feedback for wrong answer
          input.style.borderColor = 'var(--bad)';
          input.style.animation = 'shake 0.5s';
          setTimeout(() => {
            input.style.borderColor = 'var(--border)';
            input.style.animation = '';
            input.value = '';
            input.focus();
          }, 500);
        }
      };

      window.wordScrambleFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 16px;">üî§</div><div style="font-size: 24px; font-weight: 600;">Ord Scramble gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "G√¶t ordene";
    }

    // 17. RIDDLE CHALLENGE TASK
    function renderRiddleChallengeTask(container) {
      const riddles = [
        {
          question: 'Jeg har byer, men ingen huse. Jeg har skove, men ingen tr√¶er. Jeg har vand, men ingen fisk. Hvad er jeg?',
          answer: 'KORT'
        },
        {
          question: 'Jo mere jeg t√∏rrer, jo v√•dere bliver jeg. Hvad er jeg?',
          answer: 'H√ÖNDKL√ÜDE'
        },
        {
          question: 'Hvad er det, der lever og bliver st√∏rre, n√•r du fodrer det, men d√∏r hvis du giver det vand?',
          answer: 'B√ÖL'
        }
      ];

      let currentRiddle = 0;
      let solved = 0;

      function render() {
        if (currentRiddle >= riddles.length) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 80px; margin-bottom: 20px;">üß†</div>
              <div style="font-size: 32px; color: var(--ok); margin-bottom: 20px; font-weight: 700;">
                Alle ${riddles.length} g√•der l√∏st!
              </div>
              <button class="btn primary" onclick="riddleFinish()" style="padding: 16px 32px;">Forts√¶t ‚Üí</button>
            </div>
          `;
          return;
        }

        const riddle = riddles[currentRiddle];
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 600; margin-bottom: 30px;">
              üß© G√•de Udfordring
            </div>
            
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px;">
              L√∏s g√•derne for at gennemf√∏re!
            </div>

            <div style="font-size: 20px; color: var(--accent); margin-bottom: 20px;">
              G√•de ${currentRiddle + 1} af ${riddles.length}
            </div>
            
            <div style="
              background: var(--card);
              padding: 40px;
              border-radius: 16px;
              margin: 30px auto;
              max-width: 600px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            ">
              <div style="font-size: 22px; line-height: 1.6; color: var(--text); margin-bottom: 30px; font-style: italic;">
                "${riddle.question}"
              </div>
              
              <input 
                type="text" 
                id="riddleGuess"
                placeholder="Dit svar..."
                style="
                  width: 100%;
                  padding: 16px;
                  font-size: 20px;
                  text-align: center;
                  border: 2px solid var(--border);
                  border-radius: 8px;
                  background: var(--bg);
                  color: var(--text);
                  text-transform: uppercase;
                  box-sizing: border-box;
                "
                onkeypress="if(event.key === 'Enter') riddleCheck()"
              />
            </div>
            
            <button class="btn primary" onclick="riddleCheck()" style="padding: 16px 40px; font-size: 20px;">
              Tjek svar
            </button>
            
            ${solved > 0 ? `
              <div style="margin-top: 30px; font-size: 18px; color: var(--ok);">
                ‚úÖ ${solved} g√•de${solved !== 1 ? 'r' : ''} l√∏st
              </div>
            ` : ''}
          </div>
        `;

        setTimeout(() => {
          const input = document.getElementById('riddleGuess');
          if (input) input.focus();
        }, 100);
      }

      window.riddleCheck = () => {
        const input = document.getElementById('riddleGuess');
        const guess = input.value.toUpperCase().trim();
        const riddle = riddles[currentRiddle];

        if (guess === riddle.answer) {
          solved++;
          currentRiddle++;
          render();
        } else {
          // Visual feedback for wrong answer
          input.style.borderColor = 'var(--bad)';
          input.style.animation = 'shake 0.5s';
          setTimeout(() => {
            input.style.borderColor = 'var(--border)';
            input.style.animation = '';
            input.value = '';
            input.focus();
          }, 500);
        }
      };

      window.riddleFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 16px;">üß©</div><div style="font-size: 24px; font-weight: 600;">G√•de Udfordring gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "L√∏s g√•derne";
    }

    // 11. BLACKJACK TASK
    function renderBlackjackTask(container) {
      const suits = ['‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è', '‚ô†Ô∏è'];
      const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

      let deck = [];
      let playerHand = [];
      let dealerHand = [];
      let gameState = 'betting'; // betting, playing, dealer, finished
      let result = '';
      let inCooldown = false;
      let timeRemaining = 0;
      let cooldownInterval = null;

      // Get or create unique device ID
      function getDeviceId() {
        let deviceId = localStorage.getItem('blackjack_device_id');
        if (!deviceId) {
          deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('blackjack_device_id', deviceId);
        }
        return deviceId;
      }

      // Check cooldown for this device
      function checkCooldown() {
        const deviceId = getDeviceId();
        const lastPlayed = localStorage.getItem(`blackjack_cooldown_${deviceId}`);

        if (lastPlayed) {
          const timeSince = Date.now() - parseInt(lastPlayed);
          const cooldownTime = 30000; // 30 seconds

          if (timeSince < cooldownTime) {
            timeRemaining = Math.ceil((cooldownTime - timeSince) / 1000);
            inCooldown = true;
            startCooldownTimer();
            return true;
          } else {
            // Cooldown expired, clear it
            localStorage.removeItem(`blackjack_cooldown_${deviceId}`);
          }
        }
        return false;
      }

      function startCooldownTimer() {
        if (cooldownInterval) {
          clearInterval(cooldownInterval);
          const index = activeTimers.indexOf(cooldownInterval);
          if (index > -1) activeTimers.splice(index, 1);
        }

        cooldownInterval = setInterval(() => {
          timeRemaining--;
          if (timeRemaining <= 0) {
            clearInterval(cooldownInterval);
            const index = activeTimers.indexOf(cooldownInterval);
            if (index > -1) activeTimers.splice(index, 1);
            inCooldown = false;
            const deviceId = getDeviceId();
            localStorage.removeItem(`blackjack_cooldown_${deviceId}`);
          }
          render();
        }, 1000);
        activeTimers.push(cooldownInterval);
      }

      function setCooldown() {
        const deviceId = getDeviceId();
        localStorage.setItem(`blackjack_cooldown_${deviceId}`, Date.now().toString());
      }

      function createDeck() {
        deck = [];
        for (let suit of suits) {
          for (let value of values) {
            deck.push({ value, suit });
          }
        }
        // Shuffle
        for (let i = deck.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [deck[i], deck[j]] = [deck[j], deck[i]];
        }
      }

      function getCardValue(card) {
        if (card.value === 'A') return 11;
        if (['J', 'Q', 'K'].includes(card.value)) return 10;
        return parseInt(card.value);
      }

      function getHandValue(hand) {
        let value = 0;
        let aces = 0;

        for (let card of hand) {
          const cardVal = getCardValue(card);
          value += cardVal;
          if (card.value === 'A') aces++;
        }

        // Adjust for aces
        while (value > 21 && aces > 0) {
          value -= 10;
          aces--;
        }

        return value;
      }

      function drawCard() {
        return deck.pop();
      }

      function startGame() {
        if (inCooldown) return;

        createDeck();
        playerHand = [drawCard(), drawCard()];
        dealerHand = [drawCard(), drawCard()];
        gameState = 'playing';
        result = '';

        // Check for natural blackjack
        if (getHandValue(playerHand) === 21) {
          gameState = 'dealer';
          dealerPlay();
        }

        render();
      }

      function hit() {
        if (gameState !== 'playing') return;

        playerHand.push(drawCard());
        const playerValue = getHandValue(playerHand);

        if (playerValue > 21) {
          result = 'bust';
          gameState = 'finished';
        } else if (playerValue === 21) {
          stand();
        }

        render();
      }

      function stand() {
        if (gameState !== 'playing') return;
        gameState = 'dealer';
        dealerPlay();
      }

      function dealerPlay() {
        setTimeout(() => {
          while (getHandValue(dealerHand) < 17) {
            dealerHand.push(drawCard());
          }

          const playerValue = getHandValue(playerHand);
          const dealerValue = getHandValue(dealerHand);

          if (dealerValue > 21) {
            result = 'win';
          } else if (playerValue > dealerValue) {
            result = 'win';
          } else if (playerValue < dealerValue) {
            result = 'lose';
          } else {
            result = 'push';
          }

          gameState = 'finished';
          render();
        }, 1000);

        render();
      }

      function renderCard(card) {
        const color = ['‚ô•Ô∏è', '‚ô¶Ô∏è'].includes(card.suit) ? '#ef4444' : '#1f2937';
        return `
          <div style="
            display: inline-block;
            width: 70px;
            height: 100px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 0 4px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          ">
            <div style="font-size: 20px; font-weight: 700; color: ${color};">
              ${card.value}
            </div>
            <div style="font-size: 24px; margin-top: 4px;">
              ${card.suit}
            </div>
          </div>
        `;
      }

      function renderHiddenCard() {
        return `
          <div style="
            display: inline-block;
            width: 70px;
            height: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #5a67d8;
            border-radius: 8px;
            margin: 0 4px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            <div style="font-size: 32px; color: white;">üé¥</div>
          </div>
        `;
      }

      function render() {
        const playerValue = playerHand.length > 0 ? getHandValue(playerHand) : 0;
        const dealerValue = dealerHand.length > 0 ? getHandValue(dealerHand) : 0;

        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 600; margin-bottom: 30px;">
              üÉè Blackjack
            </div>
            
            ${!inCooldown && gameState !== 'betting' ? `
              <div style="margin-bottom: 40px; padding: 20px; background: var(--card); border-radius: 12px;">
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--muted);">
                  Dealer ${gameState === 'playing' ? '(??)' : '(' + dealerValue + ')'}
                </div>
                <div style="margin: 16px 0;">
                  ${renderCard(dealerHand[0])}
                  ${gameState === 'playing' ? renderHiddenCard() : dealerHand.slice(1).map(c => renderCard(c)).join('')}
                </div>
              </div>
              
              <div style="margin-bottom: 30px; padding: 20px; background: var(--card); border-radius: 12px;">
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--accent);">
                  Dig (${playerValue})
                </div>
                <div style="margin: 16px 0;">
                  ${playerHand.map(c => renderCard(c)).join('')}
                </div>
              </div>
            ` : ''}
            
            ${inCooldown ? `
              <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px;">
                Du har lige spillet. Vent lidt f√∏r n√¶ste fors√∏g!
              </div>
              <div style="font-size: 48px; font-weight: 700; color: var(--accent); margin: 30px 0;">
                ${timeRemaining}s
              </div>
              <div style="font-size: 16px; color: var(--muted);">
                Denne enhed kan spille igen om ${timeRemaining} sekund${timeRemaining !== 1 ? 'er' : ''}
              </div>
            ` : gameState === 'betting' ? `
              <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px;">
                Vind en h√•nd blackjack mod dealeren for at gennemf√∏re opgaven!
              </div>
              <button class="btn primary" onclick="bjStart()" style="font-size: 20px; padding: 20px 40px;">
                üé≤ Start spil
              </button>
            ` : gameState === 'playing' ? `
              <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                <button class="btn" onclick="bjHit()" style="padding: 16px 32px;">üé¥ Hit</button>
                <button class="btn primary" onclick="bjStand()" style="padding: 16px 32px;">‚úã Stand</button>
              </div>
            ` : gameState === 'dealer' ? `
              <div style="font-size: 20px; color: var(--muted); margin-top: 20px;">
                Dealer tr√¶kker kort...
              </div>
            ` : `
              <div style="margin-top: 30px;">
                ${result === 'win' ? `
                  <div style="font-size: 32px; color: var(--ok); margin-bottom: 20px; font-weight: 600;">
                    üéâ Du vandt!
                  </div>
                  <button class="btn primary" onclick="bjFinish()" style="padding: 16px 32px;">Forts√¶t ‚Üí</button>
                ` : result === 'bust' ? `
                  <div style="font-size: 28px; color: var(--bad); margin-bottom: 20px;">
                    üí• BUST! Over 21
                  </div>
                  <div style="font-size: 16px; color: var(--muted); margin-bottom: 20px;">
                    30 sekunders cooldown aktiveret for denne enhed
                  </div>
                  <button class="btn" onclick="bjRestart()" style="padding: 16px 32px;">Tilbage</button>
                ` : result === 'lose' ? `
                  <div style="font-size: 28px; color: var(--bad); margin-bottom: 20px;">
                    ‚ùå Dealer vandt
                  </div>
                  <div style="font-size: 16px; color: var(--muted); margin-bottom: 20px;">
                    30 sekunders cooldown aktiveret for denne enhed
                  </div>
                  <button class="btn" onclick="bjRestart()" style="padding: 16px 32px;">Tilbage</button>
                ` : `
                  <div style="font-size: 28px; color: var(--muted); margin-bottom: 20px;">
                    ü§ù Uafgjort (Push)
                  </div>
                  <div style="font-size: 16px; color: var(--muted); margin-bottom: 20px;">
                    30 sekunders cooldown aktiveret for denne enhed
                  </div>
                  <button class="btn" onclick="bjRestart()" style="padding: 16px 32px;">Tilbage</button>
                `}
              </div>
            `}
          </div>
        `;
      }

      window.bjStart = startGame;
      window.bjHit = hit;
      window.bjStand = stand;

      window.bjRestart = () => {
        setCooldown();
        checkCooldown();
      };

      window.bjFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 16px;">üÉè</div><div style="font-size: 24px; font-weight: 600;">Blackjack gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        if (cooldownInterval) {
          clearInterval(cooldownInterval);
          const index = activeTimers.indexOf(cooldownInterval);
          if (index > -1) activeTimers.splice(index, 1);
        }
        completeTask(currentTaskIndex);
      };

      // Check cooldown on initial render
      checkCooldown();
      render();
      document.getElementById("taskStatus").textContent = "Klar til at spille";
    }

    // 10. MATH SPRINT TASK
    function renderMathSprintTask(container) {
      let questions = [];
      let currentQ = 0;
      let startTime = null;
      let totalTime = 0;

      function generateQuestion() {
        const questionTypes = [
          // 1. Kvadratrod og potens
          () => {
            const base = Math.floor(Math.random() * 10) + 2; // 2-11
            const square = base * base;
            return { question: `‚àö${square} + ${base}`, answer: base + base };
          },
          // 2. Fakultet sm√• tal
          () => {
            const n = Math.floor(Math.random() * 3) + 3; // 3, 4, eller 5
            const factorial = n === 3 ? 6 : n === 4 ? 24 : 120;
            return { question: `${n}!`, answer: factorial };
          },
          // 3. Potenser
          () => {
            const base = Math.floor(Math.random() * 5) + 2; // 2-6
            const exp = Math.floor(Math.random() * 3) + 2; // 2-4
            const answer = Math.pow(base, exp);
            return { question: `${base}^${exp}`, answer: answer };
          },
          // 4. Modulus/division med rest
          () => {
            const divisor = Math.floor(Math.random() * 8) + 3; // 3-10
            const quotient = Math.floor(Math.random() * 15) + 5;
            const remainder = Math.floor(Math.random() * divisor);
            const dividend = quotient * divisor + remainder;
            return { question: `${dividend} mod ${divisor}`, answer: remainder };
          },
          // 5. Sum af talr√¶kke
          () => {
            const n = Math.floor(Math.random() * 8) + 5; // 5-12
            const sum = (n * (n + 1)) / 2;
            return { question: `Œ£(1 til ${n})`, answer: sum };
          },
          // 6. Procent beregning
          () => {
            const percent = [10, 20, 25, 50, 75].at(Math.floor(Math.random() * 5));
            const total = Math.floor(Math.random() * 10) * 20 + 100; // 100, 120, 140...
            const answer = (total * percent) / 100;
            return { question: `${percent}% af ${total}`, answer: answer };
          },
          // 7. Bin√¶r til decimal
          () => {
            const decimal = Math.floor(Math.random() * 16) + 1; // 1-16
            const binary = decimal.toString(2);
            return { question: `${binary}‚ÇÇ til base 10`, answer: decimal };
          },
          // 8. Primtal kontrol (er det primtal? 1=ja, 0=nej)
          () => {
            const primes = [2, 3, 5, 7, 11, 13, 17, 19, 23];
            const nonPrimes = [4, 6, 8, 9, 10, 12, 14, 15, 16, 18, 20, 21];
            const isPrime = Math.random() > 0.5;
            const num = isPrime ? primes[Math.floor(Math.random() * primes.length)] : nonPrimes[Math.floor(Math.random() * nonPrimes.length)];
            return { question: `Er ${num} et primtal? (1=ja, 0=nej)`, answer: isPrime ? 1 : 0 };
          },
          // 9. GCD (st√∏rste f√¶lles divisor)
          () => {
            const gcds = [[12, 8, 4], [15, 25, 5], [18, 24, 6], [14, 21, 7], [20, 30, 10]];
            const choice = gcds[Math.floor(Math.random() * gcds.length)];
            return { question: `GCD(${choice[0]}, ${choice[1]})`, answer: choice[2] };
          },
          // 10. Fibonacci tal
          () => {
            const fibs = [1, 1, 2, 3, 5, 8, 13, 21, 34, 55];
            const index = Math.floor(Math.random() * 7) + 3; // F3 til F9
            return { question: `Fibonacci F${index}`, answer: fibs[index] };
          }
        ];

        const randomType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
        return randomType();
      }

      function startQuiz() {
        questions = [];
        for (let i = 0; i < 10; i++) {
          questions.push(generateQuestion());
        }
        currentQ = 0;
        startTime = Date.now();
        render();
      }

      function checkAnswer() {
        const input = document.getElementById("mathAnswer")?.value || '';
        const errorDiv = document.getElementById("mathError");

        if (input.trim() === '') {
          errorDiv.textContent = "Indtast et svar";
          return;
        }

        const userAnswer = parseFloat(input);
        const correctAnswer = questions[currentQ].answer;

        if (userAnswer === correctAnswer) {
          currentQ++;
          if (currentQ >= questions.length) {
            totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
          }
          render();
        } else {
          errorDiv.textContent = "Forkert! Pr√∏v igen";
          document.getElementById("mathAnswer").value = "";
          setTimeout(() => {
            errorDiv.textContent = "";
          }, 2000);
        }
      }

      function render() {
        if (questions.length === 0) {
          container.innerHTML = `
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">
                Matematik Sprint üß†
              </div>
              
              <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px; line-height: 1.6;">
                L√∏s 10 universitets-niveau matematik sp√∏rgsm√•l!<br>
                Potenser, fakulteter, modulus, primtal, m.m.
              </div>
              
              <div style="font-size: 64px; margin: 40px 0;">
                üî¢
              </div>
              
              <button class="btn primary" onclick="mathStart()" style="font-size: 20px; padding: 20px 40px;">
                Start quiz! üöÄ
              </button>
            </div>
          `;
        } else if (currentQ < questions.length) {
          const q = questions[currentQ];
          container.innerHTML = `
            <div style="text-align: center;">
              <div style="font-size: 18px; color: var(--muted); margin-bottom: 20px;">
                Sp√∏rgsm√•l ${currentQ + 1}/10
              </div>
              
              <div style="font-size: 40px; font-weight: 700; margin: 40px 0; color: var(--accent); line-height: 1.4;">
                ${q.question}
              </div>
              
              <div style="max-width: 300px; margin: 30px auto;">
                <input 
                  type="text" 
                  id="mathAnswer" 
                  placeholder="Dit svar" 
                  style="width: 100%; padding: 16px; font-size: 24px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); text-align: center;"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();mathCheck();}"
                >
                <div id="mathError" style="color: var(--bad); margin-top: 12px; min-height: 24px;"></div>
                <button class="btn primary" onclick="mathCheck()" style="margin-top: 20px; width: 100%;">Tjek svar</button>
              </div>
            </div>
          `;
          setTimeout(() => document.getElementById("mathAnswer")?.focus(), 100);
        } else {
          container.innerHTML = `
            <div style="text-align: center;">
              <div style="font-size: 32px; color: var(--ok); margin: 30px 0; font-weight: 600;">
                üéâ Alle rigtige!
              </div>
              <div style="font-size: 24px; margin: 20px 0;">
                Tid: ${totalTime} sekunder
              </div>
              <button class="btn primary" onclick="mathFinish()" style="margin-top: 30px;">Forts√¶t ‚Üí</button>
            </div>
          `;
        }
      }

      window.mathStart = startQuiz;
      window.mathCheck = checkAnswer;

      window.mathFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 16px;">üß†</div><div style="font-size: 24px; font-weight: 600;">Matematik sprint gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar til matematik";
    }

    // 11. MEMORY GAME TASK
    function renderMemoryGameTask(container) {
      let sequence = [];
      let userSequence = [];
      let level = 1;
      let showingSequence = false;
      let gameStarted = false;

      function startGame() {
        sequence = [];
        userSequence = [];
        level = 1;
        gameStarted = true;
        nextLevel();
      }

      function nextLevel() {
        userSequence = [];
        // Generate completely new sequence with length = level
        sequence = [];
        for (let i = 0; i < level; i++) {
          sequence.push(Math.floor(Math.random() * 9) + 1);
        }
        showSequence();
      }

      function showSequence() {
        showingSequence = true;
        render();

        let index = 0;
        const interval = setInterval(() => {
          if (index < sequence.length) {
            highlightNumber(sequence[index]);
            index++;
          } else {
            clearInterval(interval);
            showingSequence = false;
            render();
          }
        }, 800);
      }

      function highlightNumber(num) {
        const btn = document.getElementById(`memBtn${num}`);
        if (btn) {
          btn.style.background = 'var(--accent)';
          btn.style.transform = 'scale(1.1)';
          setTimeout(() => {
            btn.style.background = '';
            btn.style.transform = '';
          }, 600);
        }
      }

      function numberClick(num) {
        if (showingSequence) return;

        userSequence.push(num);
        highlightNumber(num);

        // Check if correct so far
        const currentIndex = userSequence.length - 1;
        if (userSequence[currentIndex] !== sequence[currentIndex]) {
          // Wrong!
          setTimeout(() => {
            alert(`Forkert! Du klarede ${level - 1} niveau${level - 1 !== 1 ? 'er' : ''}. Pr√∏v igen!`);
            gameStarted = false;
            render();
          }, 300);
          return;
        }

        // Check if sequence completed
        if (userSequence.length === sequence.length) {
          if (level >= 7) {
            // Won!
            setTimeout(() => {
              render();
            }, 300);
          } else {
            // Next level
            level++;
            setTimeout(() => {
              nextLevel();
            }, 1000);
          }
        }
      }

      function render() {
        if (!gameStarted) {
          container.innerHTML = `
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">
                Hukommelses Spil üß†üî¢
              </div>
              
              <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px; line-height: 1.6;">
                Husk sekvensen af tal!<br>
                Klar ${level > 1 ? level - 1 : 7} niveauer for at vinde
              </div>
              
              <div style="font-size: 64px; margin: 40px 0;">
                üß†
              </div>
              
              <button class="btn primary" onclick="memStart()" style="font-size: 20px; padding: 20px 40px;">
                Start spil! üöÄ
              </button>
            </div>
          `;
        } else if (level > 7) {
          container.innerHTML = `
            <div style="text-align: center;">
              <div style="font-size: 32px; color: var(--ok); margin: 30px 0; font-weight: 600;">
                üéâ Du klarede det!
              </div>
              <div style="font-size: 20px; margin: 20px 0; color: var(--muted);">
                Alle 7 niveauer gennemf√∏rt!
              </div>
              <button class="btn primary" onclick="memFinish()" style="margin-top: 30px;">Forts√¶t ‚Üí</button>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div style="text-align: center;">
              <div style="font-size: 20px; color: var(--muted); margin-bottom: 20px;">
                Niveau ${level} - Husk ${sequence.length} tal
              </div>
              
              ${showingSequence ? `
                <div style="font-size: 18px; color: var(--accent); margin: 20px 0;">
                  Se og husk sekvensen...
                </div>
              ` : `
                <div style="font-size: 18px; color: var(--ok); margin: 20px 0;">
                  Tryk tallene i r√¶kkef√∏lge!
                </div>
              `}
              
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 300px; margin: 40px auto;">
                ${[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => `
                  <button 
                    id="memBtn${num}"
                    class="btn" 
                    onclick="memClick(${num})" 
                    ${showingSequence ? 'disabled' : ''}
                    style="padding: 30px; font-size: 24px; font-weight: 700; transition: all 0.3s;"
                  >
                    ${num}
                  </button>
                `).join('')}
              </div>
            </div>
          `;
        }
      }

      window.memStart = startGame;
      window.memClick = numberClick;

      window.memFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 16px;">üß†</div><div style="font-size: 24px; font-weight: 600;">Hukommelses spil gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        completeTask(currentTaskIndex);
      };

      render();
      document.getElementById("taskStatus").textContent = "Klar til at spille";
    }

    // 13. SHOT ROULETTE TASK
    function renderShotRouletteTask(container) {
      let spinning = false;
      let result = null;
      let verified = false;
      let rotation = 0;
      let currentRotation = 0;
      let hasPlayed = false;

      const drinks = [
        { name: "Olivenolie", weight: 20, emoji: "ü´í", color: "#8b7355" },
        { name: "Snaps", weight: 30, emoji: "ü•É", color: "#d4a574" },
        { name: "Remo", weight: 15, emoji: "üç∏", color: "#67c23a" },
        { name: "Fernet", weight: 30, emoji: "ü•É", color: "#8b4513" },
        { name: "Vand", weight: 5, emoji: "üíß", color: "#409eff" }
      ];

      // Get or create unique device ID
      function getDeviceId() {
        let deviceId = localStorage.getItem('shot_device_id');
        if (!deviceId) {
          deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('shot_device_id', deviceId);
        }
        return deviceId;
      }

      // Check if this device has already played
      function checkIfPlayed() {
        const deviceId = getDeviceId();
        const played = localStorage.getItem(`shot_played_${deviceId}`);
        if (played === 'true') {
          hasPlayed = true;
          return true;
        }
        return false;
      }

      // Mark this device as having played
      function markAsPlayed() {
        const deviceId = getDeviceId();
        localStorage.setItem(`shot_played_${deviceId}`, 'true');

        // Associate this device with current team
        const currentTeam = localStorage.getItem("current_team_index");
        if (currentTeam !== null) {
          localStorage.setItem(`device_team_${deviceId}`, currentTeam);
        }

        hasPlayed = true;
        updateDeviceTracker();
      }

      function spin() {
        if (spinning || hasPlayed) return;
        spinning = true;
        verified = false;
        result = null;

        // Weighted random selection first
        const totalWeight = drinks.reduce((sum, d) => sum + d.weight, 0);
        let random = Math.random() * totalWeight;
        let selectedIndex = 0;

        for (let i = 0; i < drinks.length; i++) {
          random -= drinks[i].weight;
          if (random <= 0) {
            selectedIndex = i;
            result = drinks[i];
            break;
          }
        }

        // Calculate rotation to land on selected drink
        const degreesPerSegment = 360 / drinks.length;
        // Add current rotation plus 5 full spins plus target segment
        // We need to account for the pointer being at top, so we adjust the target
        const targetAngle = (drinks.length - selectedIndex - 1) * degreesPerSegment + (degreesPerSegment / 2);
        const newRotation = currentRotation + 360 * 5 + targetAngle;
        rotation = newRotation;

        // Force a render with current rotation first to ensure smooth transition
        render();

        // Use requestAnimationFrame to ensure the transition happens
        requestAnimationFrame(() => {
          currentRotation = newRotation;
          render();
        });

        setTimeout(() => {
          spinning = false;
          render();
        }, 3000);
      }

      function render() {
        const degreesPerSegment = 360 / drinks.length;

        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">
              Shot Roulette üé∞
            </div>
            
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px; line-height: 1.6;">
              Spin hjulet og drik hvad det lander p√•!<br>
              V√¶rten godkender n√•r du har drukket.
            </div>
            
            ${hasPlayed ? `
              <div style="margin: 40px 0;">
                <div style="font-size: 48px; margin-bottom: 20px;">üé∞</div>
                <div style="font-size: 24px; color: var(--muted); margin-bottom: 20px;">
                  Dette hold har allerede spillet shot roulette!
                </div>
                <button class="btn primary" onclick="shotFinish()">Tilbage til opgaver</button>
              </div>
            ` : !result && !spinning ? `
              <div style="margin: 40px 0;">
                <div style="position: relative; width: 300px; height: 300px; margin: 0 auto;">
                  ${renderWheel(currentRotation, false)}
                  ${renderPointer()}
                </div>
                <button class="btn primary" onclick="shotSpin()" style="font-size: 20px; padding: 20px 40px; margin-top: 30px;">
                  üé≤ Spin hjulet!
                </button>
              </div>
            ` : spinning ? `
              <div style="margin: 40px 0;">
                <div style="position: relative; width: 300px; height: 300px; margin: 0 auto;">
                  ${renderWheel(currentRotation, true)}
                  ${renderPointer()}
                </div>
                <div style="font-size: 20px; color: var(--accent); margin-top: 20px;">
                  Spinner...
                </div>
              </div>
            ` : result && !verified ? `
              <div style="margin: 40px 0;">
                <div style="position: relative; width: 300px; height: 300px; margin: 0 auto 30px;">
                  ${renderWheel(currentRotation, false)}
                  ${renderPointer()}
                </div>
                <div style="font-size: 80px; margin-bottom: 20px;">${result.emoji}</div>
                <div style="font-size: 32px; font-weight: 700; color: var(--accent); margin-bottom: 30px;">
                  ${result.name}!
                </div>
                <div style="font-size: 18px; color: var(--muted); margin-bottom: 20px;">
                  Drik dit shot og f√• v√¶rten til at bekr√¶fte
                </div>
                
                <div style="max-width: 300px; margin: 30px auto;">
                  <div style="font-size: 18px; margin-bottom: 12px; color: var(--text);">
                    V√¶rt PIN-kode:
                  </div>
                  <input 
                    type="password" 
                    id="shotPin" 
                    placeholder="Indtast PIN" 
                    style="width: 100%; padding: 16px; font-size: 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); text-align: center;"
                    onkeypress="if(event.key==='Enter'){event.preventDefault();verifyShotRoulette();}"
                  >
                  <div id="shotError" style="color: var(--bad); margin-top: 12px; min-height: 24px;"></div>
                  <button class="btn primary" onclick="verifyShotRoulette()" style="margin-top: 20px; width: 100%;">‚úÖ Bekr√¶ft</button>
                </div>
              </div>
            ` : `
              <div style="margin: 40px 0;">
                <div style="font-size: 28px; color: var(--ok); margin-bottom: 20px;">
                  ‚úÖ Bekr√¶ftet af v√¶rt!
                </div>
                <button class="btn primary" onclick="shotFinish()">Forts√¶t ‚Üí</button>
              </div>
            `}
          </div>
        `;
        if (result && !verified && !spinning) {
          setTimeout(() => document.getElementById("shotPin")?.focus(), 100);
        }
      }

      function renderWheel(rotationValue, isSpinning) {
        const degreesPerSegment = 360 / drinks.length;

        return `
          <svg width="300" height="300" style="transform: rotate(${rotationValue}deg); transition: transform ${isSpinning ? '3s' : '0s'} cubic-bezier(0.17, 0.67, 0.12, 0.99);">
            ${drinks.map((drink, index) => {
          const startAngle = (index * degreesPerSegment - 90) * Math.PI / 180;
          const endAngle = ((index + 1) * degreesPerSegment - 90) * Math.PI / 180;

          const x1 = 150 + 140 * Math.cos(startAngle);
          const y1 = 150 + 140 * Math.sin(startAngle);
          const x2 = 150 + 140 * Math.cos(endAngle);
          const y2 = 150 + 140 * Math.sin(endAngle);

          const midAngle = ((index + 0.5) * degreesPerSegment - 90) * Math.PI / 180;
          const textX = 150 + 90 * Math.cos(midAngle);
          const textY = 150 + 90 * Math.sin(midAngle);

          return `
                <path 
                  d="M 150 150 L ${x1} ${y1} A 140 140 0 0 1 ${x2} ${y2} Z" 
                  fill="${drink.color}" 
                  stroke="white" 
                  stroke-width="2"
                />
                <text 
                  x="${textX}" 
                  y="${textY}" 
                  text-anchor="middle" 
                  dominant-baseline="middle" 
                  fill="white" 
                  font-size="18" 
                  font-weight="bold"
                  style="pointer-events: none;"
                >
                  ${drink.name}
                </text>
              `;
        }).join('')}
            <circle cx="150" cy="150" r="25" fill="white" stroke="#333" stroke-width="3"/>
          </svg>
        `;
      }

      function renderPointer() {
        return `
          <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #ff5c7a; z-index: 10; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));"></div>
        `;
      }

      window.shotSpin = spin;

      window.verifyShotRoulette = () => {
        const input = document.getElementById("shotPin")?.value || '';
        const errorDiv = document.getElementById("shotError");

        if (input === PIN) {
          verified = true;
          markAsPlayed();
          render();
        } else {
          errorDiv.textContent = "Forkert PIN - pr√∏v igen";
          document.getElementById("shotPin").value = "";
          setTimeout(() => {
            errorDiv.textContent = "";
          }, 2000);
        }
      };

      window.shotFinish = () => {
        showTasksOverview();
      };

      // Check if already played on initial render
      checkIfPlayed();
      render();
      document.getElementById("taskStatus").textContent = "Klar til at spinde";
    }

    // 14. SLOT MACHINE TASK
    function renderSlotMachineTask(container) {
      let spinning = false;
      let reels = ['üçí', 'üçã', 'üçá'];
      let attempts = 0;
      let inCooldown = false;
      let timeRemaining = 0;
      let cooldownInterval = null;

      const symbols = ['üçí', 'üçã', 'üçá', 'üçë', '‚≠ê', 'üîî', 'üí∞'];
      const maxAttempts = 3;

      // Get or create unique device ID
      function getDeviceId() {
        let deviceId = localStorage.getItem('slot_device_id');
        if (!deviceId) {
          deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('slot_device_id', deviceId);
        }
        return deviceId;
      }

      // Check cooldown for this device
      function checkCooldown() {
        const deviceId = getDeviceId();
        const cooldownData = localStorage.getItem(`slot_cooldown_${deviceId}`);

        if (cooldownData) {
          const data = JSON.parse(cooldownData);
          const timeSince = Date.now() - data.timestamp;
          const cooldownTime = 30000; // 30 seconds

          if (timeSince < cooldownTime) {
            timeRemaining = Math.ceil((cooldownTime - timeSince) / 1000);
            inCooldown = true;
            attempts = data.attempts;
            startCooldownTimer();
            return true;
          } else {
            // Cooldown expired, reset attempts
            localStorage.removeItem(`slot_cooldown_${deviceId}`);
            attempts = 0;
          }
        }
        return false;
      }

      function startCooldownTimer() {
        if (cooldownInterval) {
          clearInterval(cooldownInterval);
          const index = activeTimers.indexOf(cooldownInterval);
          if (index > -1) activeTimers.splice(index, 1);
        }

        cooldownInterval = setInterval(() => {
          timeRemaining--;
          if (timeRemaining <= 0) {
            clearInterval(cooldownInterval);
            const index = activeTimers.indexOf(cooldownInterval);
            if (index > -1) activeTimers.splice(index, 1);
            inCooldown = false;
            attempts = 0;
            const deviceId = getDeviceId();
            localStorage.removeItem(`slot_cooldown_${deviceId}`);
          }
          render();
        }, 1000);
        activeTimers.push(cooldownInterval);
      }

      function setCooldown() {
        const deviceId = getDeviceId();
        localStorage.setItem(`slot_cooldown_${deviceId}`, JSON.stringify({
          timestamp: Date.now(),
          attempts: attempts
        }));
      }

      function spin() {
        if (spinning || inCooldown) return;

        attempts++;

        // Check if reached max attempts
        if (attempts >= maxAttempts) {
          spinning = true;
        } else {
          spinning = true;
        }

        let spinCount = 0;
        const maxSpins = 20;

        const interval = setInterval(() => {
          reels = [
            symbols[Math.floor(Math.random() * symbols.length)],
            symbols[Math.floor(Math.random() * symbols.length)],
            symbols[Math.floor(Math.random() * symbols.length)]
          ];
          render();
          spinCount++;

          if (spinCount >= maxSpins) {
            clearInterval(interval);
            spinning = false;

            // If reached max attempts and didn't win, start cooldown
            const isWin = checkWin();
            if (!isWin && attempts >= maxAttempts) {
              setCooldown();
              checkCooldown();
            }

            render();
          }
        }, 100);
      }

      function checkWin() {
        return reels[0] === reels[1] && reels[1] === reels[2];
      }

      function render() {
        const isWin = checkWin();

        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">
              Slot Machine üé∞
            </div>
            
            <div style="font-size: 18px; color: var(--muted); margin-bottom: 30px;">
              F√• tre ens symboler for at vinde!
            </div>
            
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 20px; margin: 30px auto; max-width: 400px; box-shadow: 0 8px 16px rgba(0,0,0,0.3);">
              <div style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
                ${reels.map(symbol => `
                  <div style="
                    background: white;
                    width: 100px;
                    height: 100px;
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 60px;
                    box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
                    ${spinning ? 'animation: slotSpin 0.1s linear infinite;' : ''}
                  ">
                    ${symbol}
                  </div>
                `).join('')}
              </div>
            </div>
            
            <style>
              @keyframes slotSpin {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-5px); }
              }
            </style>
            
            ${isWin && !spinning ? `
              <div style="font-size: 32px; color: var(--ok); margin: 30px 0; font-weight: 600;">
                üéâ JACKPOT!
              </div>
              <div style="font-size: 20px; margin: 10px 0; color: var(--muted);">
                Fors√∏g brugt: ${attempts}
              </div>
              <button class="btn primary" onclick="slotFinish()" style="margin-top: 20px;">Forts√¶t ‚Üí</button>
            ` : inCooldown ? `
              <div style="font-size: 18px; color: var(--muted); margin: 20px 0;">
                Du har brugt dine ${maxAttempts} fors√∏g. Vent lidt!
              </div>
              <div style="font-size: 48px; font-weight: 700; color: var(--accent); margin: 30px 0;">
                ${timeRemaining}s
              </div>
              <div style="font-size: 16px; color: var(--muted);">
                Denne enhed kan spille igen om ${timeRemaining} sekund${timeRemaining !== 1 ? 'er' : ''}
              </div>
            ` : `
              <div style="font-size: 18px; color: var(--muted); margin: 20px 0;">
                Fors√∏g: ${attempts}/${maxAttempts}
              </div>
              <button class="btn primary" onclick="slotSpin()" ${spinning ? 'disabled' : ''} style="font-size: 20px; padding: 20px 40px;">
                ${spinning ? 'Spinner...' : 'üé∞ Spin!'}
              </button>
            `}
          </div>
        `;
      }

      window.slotSpin = spin;

      window.slotFinish = () => {
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 16px;">üé∞</div><div style="font-size: 24px; font-weight: 600;">Slot machine gennemf√∏rt!</div></div>';
        document.getElementById("taskStatus").textContent = "‚úÖ Gennemf√∏rt";
        if (cooldownInterval) {
          clearInterval(cooldownInterval);
          const index = activeTimers.indexOf(cooldownInterval);
          if (index > -1) activeTimers.splice(index, 1);
        }
        completeTask(currentTaskIndex);
      };

      // Check cooldown on initial render
      checkCooldown();
      render();
      document.getElementById("taskStatus").textContent = "Klar til at spille";
    }

    // ===== EVENT LISTENERS =====

    document.getElementById("pinOkBtn").addEventListener("click", verifyPin);

    document.getElementById("pinInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        verifyPin();
      }
    });

    document.getElementById("editOkBtn").addEventListener("click", saveEdit);

    document.getElementById("editInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        saveEdit();
      }
    });

    // Listen for localStorage changes from other tabs/devices
    window.addEventListener("storage", (e) => {
      if (e.key === "completedTasks") {
        // Reload completed tasks
        const savedTasks = localStorage.getItem("completedTasks");
        if (savedTasks) {
          try {
            completedTasks = JSON.parse(savedTasks);

            // Check if currently viewing a task that was just completed
            const taskDetail = document.getElementById("taskDetail");
            if (taskDetail.classList.contains("active") && completedTasks.includes(currentTaskIndex)) {
              // Task was completed by someone else - go back to overview
              showTasksOverview();
            }

            // Update the grid
            renderTaskGrid();
            updateTeamProgressTracker();
          } catch (e) {
            console.error("Kunne ikke indl√¶se opgaver");
          }
        }
      } else if (e.key === "scoreboardData") {
        // Reload scoreboard
        loadData();
        renderScoreboard();
      } else if (e.key && (e.key.startsWith("shot_played_") || e.key.startsWith("team_") || e.key.startsWith("device_team_"))) {
        // Update team progress tracker when tasks are completed
        updateTeamProgressTracker();
      }
    });

    // ===== TEAM PROGRESS TRACKER =====
    function updateTeamProgressTracker() {
      const progressEl = document.getElementById("teamProgress");
      const teamData = [];

      // Get all teams and their completed tasks
      teams.forEach((team, index) => {
        const teamTasksKey = `team_${index}_tasks`;
        const completedTaskIndices = JSON.parse(localStorage.getItem(teamTasksKey) || '[]');

        // Also check for shot roulette completion
        let shotRouletteCompleted = false;
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith("shot_played_")) {
            const deviceId = key.replace("shot_played_", "");
            const teamKey = `device_team_${deviceId}`;
            const deviceTeamIndex = localStorage.getItem(teamKey);
            if (deviceTeamIndex == index && localStorage.getItem(key) === "true") {
              shotRouletteCompleted = true;
              break;
            }
          }
        }

        if (completedTaskIndices.length > 0 || shotRouletteCompleted) {
          teamData.push({
            name: team.name,
            index: index,
            completedTasks: completedTaskIndices,
            shotRouletteCompleted: shotRouletteCompleted
          });
        }
      });

      if (teamData.length === 0) {
        progressEl.innerHTML = `
          <div style="text-align: center; color: var(--muted); font-size: 13px; padding: 20px 0;">
            Ingen opgaver gennemf√∏rt endnu
          </div>
        `;
      } else {
        progressEl.innerHTML = teamData.map(team => {
          const allTasks = [...team.completedTasks];

          // Find shot roulette task index
          const shotRouletteIndex = tasks.findIndex(t => t.type === 'shot-roulette');
          if (team.shotRouletteCompleted && shotRouletteIndex !== -1 && !allTasks.includes(shotRouletteIndex)) {
            allTasks.push(shotRouletteIndex);
          }

          const totalTasks = allTasks.length;

          return `
            <div class="team-progress-item">
              <div class="team-progress-name">${team.name}</div>
              <div class="task-list">
                ${allTasks.map(taskIndex => {
            const task = tasks[taskIndex];
            if (!task) return '';
            // Extract points from title
            const pointsMatch = task.title.match(/(\d+)\s*Point/);
            const points = pointsMatch ? pointsMatch[1] : '?';
            return `
                    <div class="task-list-item completed">
                      <span>‚úÖ</span>
                      <span>${task.title.split(' - ')[0]} (${points}p)</span>
                    </div>
                  `;
          }).join('')}
              </div>
              <div class="task-count">
                ${totalTasks} opgave${totalTasks !== 1 ? 'r' : ''} gennemf√∏rt
              </div>
            </div>
          `;
        }).join('');
      }
    }

    // Compatibility function name
    function updateDeviceTracker() {
      updateTeamProgressTracker();
    }

    // ===== TEAM SELECTOR =====
    function showTeamSelector() {
      const modal = document.getElementById("teamSelectorModal");
      const selector = document.getElementById("teamSelector");

      // Get current team if any
      const currentTeam = localStorage.getItem("current_team_index");

      selector.innerHTML = teams.map((team, index) => `
        <button 
          class="team-selector-btn ${currentTeam == index ? 'selected' : ''}" 
          onclick="selectTeam(${index})"
          id="teamBtn${index}"
        >
          ${team.name}
        </button>
      `).join('');

      selectedTeamIndex = currentTeam !== null ? parseInt(currentTeam) : null;
      modal.classList.add("show");
    }

    function selectTeam(index) {
      selectedTeamIndex = index;

      // Update UI
      document.querySelectorAll('.team-selector-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById(`teamBtn${index}`).classList.add('selected');
    }

    function confirmTeamSelection() {
      if (selectedTeamIndex !== null) {
        localStorage.setItem("current_team_index", selectedTeamIndex.toString());

        // Store team association for this device
        const deviceId = getGlobalDeviceId();
        localStorage.setItem(`device_team_${deviceId}`, selectedTeamIndex.toString());

        document.getElementById("teamSelectorModal").classList.remove("show");
        updateCurrentTeamDisplay();
        updateDeviceTracker();
      }
    }

    function getGlobalDeviceId() {
      let deviceId = localStorage.getItem('global_device_id');
      if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('global_device_id', deviceId);
      }
      return deviceId;
    }

    function updateCurrentTeamDisplay() {
      const currentTeam = localStorage.getItem("current_team_index");
      let badge = document.getElementById("currentTeamBadge");

      if (!badge) {
        badge = document.createElement("div");
        badge.id = "currentTeamBadge";
        badge.className = "current-team-badge";
        badge.style.cssText = "text-align: center; cursor: pointer;";
        badge.onclick = showTeamSelector;

        const brand = document.querySelector(".brand");
        brand.parentNode.insertBefore(badge, brand.nextSibling);
      }

      if (currentTeam !== null) {
        const index = parseInt(currentTeam);
        if (!isNaN(index) && teams[index]) {
          badge.textContent = `üì± ${teams[index].name} (Klik for at √¶ndre)`;
          badge.style.display = "block";
        }
      } else {
        badge.textContent = "üì± V√¶lg dit hold (Klik her)";
        badge.style.display = "block";
      }
    }

    // ===== INITIALIZE =====
    loadData();
    renderScoreboard();
    renderTaskGrid();
    updateTeamProgressTracker();
    updateCurrentTeamDisplay();

    // Show team selector on first load if not set
    if (localStorage.getItem("current_team_index") === null) {
      setTimeout(showTeamSelector, 500);
    }
  </script>
</body>

</html>